<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Libreria Definitiva</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Libre+Baskerville:ital@0;1&display=swap" rel="stylesheet">
<style>
    :root {
        --accent: #FFD700;
        --dark: #0a0a0a;
        --glass: rgba(15, 15, 20, 0.95);
        --border: 1px solid rgba(255,255,255,0.15);
    }
    
    body { margin: 0; overflow: hidden; background: #000; font-family: 'Inter', sans-serif; color: white; }
    
    /* --- LIVELLO 1: BACKGROUND E STANZA --- */
    .viewport {
        position: relative; width: 100vw; height: 100vh;
        perspective: 1500px; /* Profondità scena */
        overflow: hidden;
    }
    
    .room-bg {
        position: absolute; inset: 0; width: 100%; height: 100%;
        object-fit: cover; z-index: 0;
        filter: brightness(0.5); /* Scuriamo per far risaltare i libri */
        transform: scale(1.02);
    }

    /* --- LIVELLO 2: ZONE DI POSIZIONAMENTO --- */
    /* Queste zone sono invisibili ma servono a piazzare i libri */
    
    /* Scaffale Alto (Letti) */
    .zone-shelf-high {
        position: absolute; top: 13%; left: 47%; width: 28%; height: 14%;
        display: flex; align-items: flex-end; gap: 2px;
        z-index: 10;
        /* border: 1px solid red; /* Decommenta per vedere la zona */
    }
    
    /* Scaffale Basso (Da Leggere) */
    .zone-shelf-low {
        position: absolute; top: 31%; left: 47%; width: 28%; height: 14%;
        display: flex; align-items: flex-end; gap: 2px;
        z-index: 10;
    }

    /* Tavolo (In Lettura) */
    .zone-table {
        position: absolute; bottom: 15%; left: 20%; width: 40%; height: 30%;
        display: flex; align-items: center; justify-content: center;
        perspective: 800px; /* Prospettiva locale per il libro sul tavolo */
        z-index: 20;
    }
    
    /* Wishlist (Angolo basso dx) */
    .zone-wishlist {
        position: absolute; bottom: 5%; right: 5%; width: 15%; height: 15%;
        z-index: 20;
    }

    /* --- LIVELLO 3: OGGETTI LIBRO --- */
    
    /* 1. LIBRO DORSO (Scaffale) */
    .spine {
        position: relative; width: 28px; height: 90%;
        border-radius: 2px; cursor: pointer;
        transition: 0.2s;
        box-shadow: 2px 0 5px rgba(0,0,0,0.8);
        background: linear-gradient(90deg, #333, #555 30%, #222);
    }
    .spine:hover { transform: scale(1.1) translateY(-5px); z-index: 100; background: #666; }
    
    /* Testo verticale sul dorso */
    .spine span {
        writing-mode: vertical-rl; text-orientation: mixed;
        position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
        font-family: 'Libre Baskerville', serif; font-size: 9px; color: rgba(255,255,255,0.7);
        overflow: hidden; white-space: nowrap; padding: 4px 0;
    }

    /* 2. LIBRO 3D (Tavolo) - Questo dà l'effetto realistico */
    .book-3d-wrapper {
        width: 140px; height: 200px;
        position: relative;
        transform-style: preserve-3d;
        transform: rotateX(45deg) rotateZ(-15deg); /* Angolazione tavolo */
        transition: transform 0.3s;
        cursor: pointer;
    }
    
    .book-3d-wrapper:hover {
        transform: rotateX(10deg) rotateZ(0deg) translateZ(40px) scale(1.1); /* Si alza al passaggio */
        z-index: 1000;
    }

    /* Facce del libro 3D */
    .face-front {
        position: absolute; inset: 0;
        background-color: #333; background-size: cover; background-position: center;
        transform: translateZ(12px); /* Spessore */
        border-radius: 2px 4px 4px 2px;
        box-shadow: inset 2px 0 5px rgba(255,255,255,0.1);
    }
    .face-side { /* Pagine laterali */
        position: absolute; top: 2px; bottom: 2px; right: 0; width: 24px;
        background: linear-gradient(to right, #eee, #ccc 20%, #eee 40%, #ddd);
        transform: rotateY(90deg) translateZ(-1px); transform-origin: right;
    }
    .face-bottom { /* Pagine sotto */
        position: absolute; bottom: 0; left: 2px; right: 2px; height: 24px;
        background: #ddd;
        transform: rotateX(-90deg) translateZ(0); transform-origin: bottom;
    }
    .book-shadow { /* Ombra sganciata per realismo */
        position: absolute; width: 100%; height: 100%; top: 20px; left: 10px;
        background: rgba(0,0,0,0.6); filter: blur(10px);
        transform: translateZ(-20px);
    }

    /* 3. WISHLIST ITEM */
    .wish-item {
        width: 80px; height: 110px; position: absolute;
        background: white; padding: 5px; color: black; font-size: 9px; text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        cursor: pointer; transition: 0.2s;
    }
    .wish-item:hover { transform: scale(1.2) !important; z-index: 100; }
    .wish-item img { width: 100%; height: 70px; object-fit: cover; background: #eee; margin-bottom: 2px; }

    /* --- UI OVERLAYS --- */
    .top-bar {
        position: absolute; top: 0; left: 0; width: 100%; padding: 20px;
        display: flex; justify-content: space-between; align-items: center;
        background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
        z-index: 1000; pointer-events: none;
    }
    .top-bar * { pointer-events: auto; }

    .btn {
        background: rgba(255,255,255,0.1); border: var(--border); color: white;
        padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;
        backdrop-filter: blur(10px); transition: 0.2s;
    }
    .btn:hover { background: white; color: black; }
    .btn-primary { background: var(--accent); color: black; border: none; }
    .btn-danger { background: #dc2626; color: white; border: none; }

    /* PANNELLO LATERALE */
    .panel {
        position: fixed; top: 0; right: 0; bottom: 0; width: 400px;
        background: var(--glass); border-left: var(--border);
        transform: translateX(100%); transition: 0.3s;
        padding: 30px; z-index: 2000; overflow-y: auto;
    }
    .panel.open { transform: translateX(0); }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-size: 11px; color: var(--accent); margin-bottom: 5px; font-weight: bold; letter-spacing: 0.5px; }
    input, select, textarea {
        width: 100%; background: rgba(255,255,255,0.1); border: 1px solid #444;
        color: white; padding: 12px; border-radius: 4px; font-family: inherit;
    }
    input:focus { border-color: var(--accent); outline: none; }

    /* Search Results */
    .search-res {
        background: #111; border: 1px solid #333; max-height: 250px; overflow-y: auto;
        display: none; border-radius: 4px; margin-top: 5px;
    }
    .search-res.active { display: block; }
    .res-item { display: flex; gap: 10px; padding: 10px; border-bottom: 1px solid #222; cursor: pointer; }
    .res-item:hover { background: #222; }
    .res-img { width: 35px; height: 50px; object-fit: cover; background: #333; }

    /* MODALE DETTAGLIO */
    .modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 3000;
        display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    .modal-overlay.active { display: flex; }
    .modal {
        background: #1a1a1a; width: 500px; max-width: 90%; border-radius: 8px;
        border: var(--border); overflow: hidden; display: flex;
        box-shadow: 0 50px 100px rgba(0,0,0,1);
    }
    .m-cover { width: 160px; object-fit: cover; background: #000; }
    .m-body { padding: 25px; flex: 1; display: flex; flex-direction: column; }
    
    .stars { color: #555; font-size: 20px; margin: 10px 0; cursor: pointer; }
    .stars span.active { color: var(--accent); }

    .ext-links { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; }
    .link-btn {
        background: #333; color: #fff; text-decoration: none; font-size: 12px;
        padding: 8px; border-radius: 4px; text-align: center; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px;
    }
    .link-btn:hover { background: #555; }
    .link-amazon:hover { background: #ff9900; color: black; }

</style>
</head>
<body>

<div class="top-bar">
    <h2 style="margin:0">Libreria <span style="color:var(--accent)">6.0</span></h2>
    <div style="display:flex; gap:10px;">
        <button class="btn danger" onclick="resetDB()">⚠ RESET TOTALE</button>
        <button class="btn primary" onclick="openPanel()">+ GESTISCI LIBRI</button>
    </div>
</div>

<div class="viewport">
    <img src="./assets/room.jpg" class="room-bg" onerror="this.style.display='none'; document.body.style.background='#111'">
    
    <div class="zone-shelf-high" id="zone-read"></div>
    <div class="zone-shelf-low" id="zone-toread"></div>
    <div class="zone-table" id="zone-reading"></div>
    <div class="zone-wishlist" id="zone-wishlist"></div>
</div>

<div class="panel" id="panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3>Aggiungi / Modifica</h3>
        <button class="btn" onclick="closePanel()" style="padding:5px 10px;">✕</button>
    </div>

    <div class="form-group" style="margin-top:20px;">
        <label>Cerca Google Books (Italiano)</label>
        <input id="inpSearch" placeholder="Es. Calvino, Eco..." autocomplete="off">
        <div class="search-res" id="resBox"></div>
    </div>

    <hr style="border-color:#333; margin:20px 0;">

    <div class="form-group">
        <label>Titolo *</label>
        <input id="inpTitle">
    </div>

    <div style="display:flex; gap:10px;">
        <div class="form-group" style="flex:1">
            <label>Autore</label>
            <input id="inpAuthor">
        </div>
        <div class="form-group" style="width:80px">
            <label>Pag.</label>
            <input id="inpPages" type="number" value="200">
        </div>
    </div>

    <div class="form-group">
        <label>Stato</label>
        <select id="inpStatus">
            <option value="reading">In Lettura (Sul Tavolo)</option>
            <option value="read">Letto (Scaffale Alto)</option>
            <option value="toread">Da Leggere (Scaffale Basso)</option>
            <option value="wishlist">Wishlist (Angolo)</option>
        </select>
    </div>

    <div class="form-group">
        <label>Colore Dorso</label>
        <select id="inpColor">
            <option value="#7f1d1d">Rosso Scuro</option>
            <option value="#1e3a8a">Blu Notte</option>
            <option value="#14532d">Verde Bosco</option>
            <option value="#171717">Nero</option>
            <option value="#57534e">Grigio</option>
        </select>
    </div>

    <div class="form-group">
        <label>Note</label>
        <textarea id="inpNote" rows="3"></textarea>
    </div>

    <button class="btn primary" style="width:100%; padding:15px;" onclick="saveBook()">SALVA</button>
</div>

<div class="modal-overlay" id="modal">
    <div class="modal">
        <img id="m-cover" class="m-cover" src="">
        <div class="m-body">
            <div style="display:flex; justify-content:space-between;">
                <h2 id="m-title" style="margin:0; color:var(--accent); font-family:'Playfair Display'">Titolo</h2>
                <button onclick="closeModal()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">✕</button>
            </div>
            <p id="m-author" style="color:#aaa; margin-top:5px;">Autore</p>
            
            <div class="stars" id="m-stars">
                <span onclick="rate(1)">★</span><span onclick="rate(2)">★</span><span onclick="rate(3)">★</span><span onclick="rate(4)">★</span><span onclick="rate(5)">★</span>
            </div>

            <p id="m-note" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px; font-style:italic; font-size:13px; flex:1;">...</p>

            <div class="ext-links">
                <a href="#" id="lnk-amazon" target="_blank" class="link-btn link-amazon"><i class="fab fa-amazon"></i> Amazon</a>
                <a href="#" id="lnk-kindle" target="_blank" class="link-btn"><i class="fas fa-tablet-alt"></i> Kindle</a>
                <a href="#" id="lnk-audible" target="_blank" class="link-btn"><i class="fas fa-headphones"></i> Audible</a>
                <button onclick="deleteBook()" class="link-btn" style="background:#7f1d1d; border:none; cursor:pointer;">Elimina</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- DATI ---
const DB_KEY = "lib_6_fix";
let books = [];
let tempCover = "";
let focusId = null;

// Caricamento
const saved = localStorage.getItem(DB_KEY);
if(saved) {
    try { books = JSON.parse(saved); } catch(e) { books=[]; }
}

// --- GOOGLE BOOKS SEARCH FIX ---
const inpSearch = document.getElementById('inpSearch');
const resBox = document.getElementById('resBox');
let timer;

inpSearch.addEventListener('input', (e) => {
    clearTimeout(timer);
    const q = e.target.value.trim();
    if(q.length < 3) { resBox.classList.remove('active'); return; }

    timer = setTimeout(async () => {
        try {
            // Chiamata API standard pubblica
            const res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&langRestrict=it&maxResults=5`);
            const data = await res.json();
            
            if(data.items) {
                resBox.innerHTML = data.items.map(i => {
                    const info = i.volumeInfo;
                    const img = info.imageLinks?.smallThumbnail || '';
                    // Creiamo un oggetto sicuro da passare
                    const safeData = encodeURIComponent(JSON.stringify({
                        title: info.title || "",
                        author: info.authors?.[0] || "",
                        pages: info.pageCount || 200,
                        cover: info.imageLinks?.thumbnail || ""
                    }));
                    
                    return `
                    <div class="res-item" onclick="fillForm('${safeData}')">
                        <img src="${img}" class="res-img">
                        <div>
                            <div style="font-weight:bold; font-size:13px; color:white;">${info.title}</div>
                            <div style="font-size:11px; color:#999;">${info.authors?.[0]||'?'}</div>
                        </div>
                    </div>`;
                }).join('');
                resBox.classList.add('active');
            }
        } catch(e) { console.error("Errore Ricerca", e); }
    }, 500);
});

function fillForm(safeData) {
    const data = JSON.parse(decodeURIComponent(safeData));
    document.getElementById('inpTitle').value = data.title;
    document.getElementById('inpAuthor').value = data.author;
    document.getElementById('inpPages').value = data.pages;
    tempCover = data.cover;
    resBox.classList.remove('active');
    document.getElementById('inpSearch').value = "";
}

// --- SALVATAGGIO ---
function saveBook() {
    const t = document.getElementById('inpTitle').value;
    if(!t) return alert("Inserisci almeno il titolo");

    const newBook = {
        id: Date.now().toString(),
        title: t,
        author: document.getElementById('inpAuthor').value,
        pages: document.getElementById('inpPages').value,
        status: document.getElementById('inpStatus').value,
        color: document.getElementById('inpColor').value,
        note: document.getElementById('inpNote').value,
        cover: tempCover,
        rating: 0
    };

    books.push(newBook);
    localStorage.setItem(DB_KEY, JSON.stringify(books));
    
    // Reset
    document.getElementById('inpTitle').value = "";
    document.getElementById('inpNote').value = "";
    tempCover = "";
    closePanel();
    render();
}

// --- RENDER SCENA ---
function render() {
    // Svuota zone
    ['zone-read', 'zone-toread', 'zone-reading', 'zone-wishlist'].forEach(id => document.getElementById(id).innerHTML = '');

    books.forEach(b => {
        const el = document.createElement('div');
        el.onclick = () => openModal(b.id);

        // 1. DORSI VERTICALI (SCAFFALI)
        if(b.status === 'read' || b.status === 'toread') {
            el.className = 'spine';
            el.style.background = `linear-gradient(90deg, ${b.color}, #333 30%, ${b.color})`;
            // Spessore e altezza dinamici
            el.style.width = Math.min(Math.max(b.pages/10, 20), 45) + 'px';
            el.style.height = (80 + (b.title.length % 15)) + '%';
            
            el.innerHTML = `<span>${b.title}</span>`;
            
            if(b.status === 'read') document.getElementById('zone-read').appendChild(el);
            else document.getElementById('zone-toread').appendChild(el);
        }
        
        // 2. LIBRO 3D (TAVOLO)
        else if(b.status === 'reading') {
            el.className = 'book-3d-wrapper';
            const cvr = b.cover || 'https://via.placeholder.com/150x200/333/fff?text=' + encodeURI(b.title);
            
            el.innerHTML = `
                <div class="book-shadow"></div>
                <div class="face-front" style="background-image:url('${cvr}')"></div>
                <div class="face-side"></div>
                <div class="face-bottom"></div>
            `;
            document.getElementById('zone-reading').appendChild(el);
        }

        // 3. WISHLIST
        else if(b.status === 'wishlist') {
            el.className = 'wish-item';
            el.style.transform = `rotate(${(Math.random()*20)-10}deg)`;
            el.style.marginTop = "-80px"; // Effetto pila
            el.innerHTML = `<img src="${b.cover || 'https://via.placeholder.com/80'}"><div>${b.title}</div>`;
            document.getElementById('zone-wishlist').appendChild(el);
        }
    });
}

// --- MODAL & LINK ---
function openModal(id) {
    focusId = id;
    const b = books.find(x => x.id === id);
    document.getElementById('m-title').innerText = b.title;
    document.getElementById('m-author').innerText = b.author;
    document.getElementById('m-note').innerText = b.note || "Nessuna nota.";
    document.getElementById('m-cover').src = b.cover || "https://via.placeholder.com/150x200";
    
    // Setup Rating
    const stars = document.getElementById('m-stars').children;
    for(let i=0; i<5; i++) {
        stars[i].className = i < b.rating ? 'active' : '';
    }

    // Setup Links
    const q = encodeURIComponent(`${b.title} ${b.author}`);
    document.getElementById('lnk-amazon').href = `https://www.amazon.it/s?k=${q}&i=stripbooks`;
    document.getElementById('lnk-kindle').href = `https://www.amazon.it/s?k=${q}&i=digital-text`;
    document.getElementById('lnk-audible').href = `https://www.audible.it/search?keywords=${q}`;

    document.getElementById('modal').classList.add('active');
}

function rate(n) {
    const b = books.find(x => x.id === focusId);
    if(b) {
        b.rating = n;
        localStorage.setItem(DB_KEY, JSON.stringify(books));
        openModal(focusId); // Refresh UI
    }
}

function deleteBook() {
    if(!confirm("Sicuro?")) return;
    books = books.filter(b => b.id !== focusId);
    localStorage.setItem(DB_KEY, JSON.stringify(books));
    closeModal();
    render();
}

function closeModal() { document.getElementById('modal').classList.remove('active'); }
function openPanel() { document.getElementById('panel').classList.add('open'); }
function closePanel() { document.getElementById('panel').classList.remove('open'); }
function resetDB() { 
    if(confirm("Cancellare tutto per risolvere errori?")) {
        localStorage.removeItem(DB_KEY); 
        location.reload(); 
    }
}

// Avvio
render();
</script>
</body>
</html>
