<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Libreria – Stanza</title>
  <style>
    :root{
      --bg:#070a0f;
      --panel:rgba(16,20,28,.78);
      --panel2:rgba(16,20,28,.60);
      --text:#e9eef6;
      --muted:#9aa8bd;
      --line:rgba(255,255,255,.10);
      --accent:#7aa2ff;
      --ok:#6ee7b7;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --radius:18px;
      --radius2:14px;
      --font:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background:var(--bg);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Background stanza (decorativo) */
    body.room-on{
      background-image:
        radial-gradient(1200px 600px at 30% 30%, rgba(255,180,110,.12), transparent 55%),
        radial-gradient(900px 500px at 70% 40%, rgba(120,160,255,.10), transparent 55%),
        url("./assets/room.jpg");
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
    }
    body.room-on::before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 700px at 50% 40%, rgba(0,0,0,.25), rgba(0,0,0,.70)),
        linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.55));
      pointer-events:none;
      z-index:0;
    }

    .wrap{
      position:relative;
      z-index:1;
      max-width:1200px;
      margin:0 auto;
      padding:26px 18px 80px;
    }

    header{
      display:flex;
      gap:14px;
      align-items:flex-end;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:16px;
    }
    .title h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
    }
    .title p{
      margin:6px 0 0;
      color:var(--muted);
      font-size:13px;
    }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }

    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      font-size:13px;
      user-select:none;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:650;
      transition:.15s transform, .15s opacity, .15s background;
    }
    .btn:hover{background:rgba(255,255,255,.06)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background:rgba(122,162,255,.22);
      border-color:rgba(122,162,255,.35);
    }
    .btn.danger{
      color:var(--bad);
      border-color:rgba(251,113,133,.40);
      background:rgba(251,113,133,.06);
    }
    .btn.small{padding:8px 10px; border-radius:10px; font-size:13px}
    .btn.ghost{
      background:transparent;
      border-color:rgba(255,255,255,.12);
    }

    .panel{
      border:1px solid var(--line);
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
    }
    .panel.pad{padding:16px}
    /* IMPORTANT: evita che la tendina venga “tagliata” */
    .panel.formpanel{ overflow: visible; }
    .panel.listpanel{ overflow:hidden; }

    .grid{
      display:grid;
      gap:14px;
    }
    .grid.form{
      grid-template-columns: 1.6fr .8fr .8fr 1.3fr;
      align-items:end;
    }
    @media (max-width: 980px){
      .grid.form{grid-template-columns:1fr 1fr}
    }
    @media (max-width: 560px){
      .grid.form{grid-template-columns:1fr}
    }

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin:0 0 6px;
    }
    input, select, textarea{
      width:100%;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      border-radius:12px;
      padding:11px 12px;
      outline:none;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus{
      border-color:rgba(122,162,255,.55);
      box-shadow:0 0 0 3px rgba(122,162,255,.15);
    }
    textarea{min-height:82px; resize:vertical}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .muted{color:var(--muted)}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}

    /* Lookup dropdown */
    .lookup-wrap{position:relative;}
    .dropdown{
      position:absolute;
      left:0; right:0;
      top:calc(100% + 8px);
      z-index:9999;
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      background:rgba(10,12,18,.96);
      box-shadow:0 30px 90px rgba(0,0,0,.75);
      overflow:hidden;
      max-height:340px;
      display:none;
    }
    .dropdown.on{display:block;}
    .dropdown .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12px;
    }
    .dd-list{max-height:300px; overflow:auto;}
    .dd-item{
      display:flex;
      gap:10px;
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.06);
      cursor:pointer;
      align-items:center;
    }
    .dd-item:hover{background:rgba(255,255,255,.06)}
    .cover{
      width:34px; height:50px;
      border-radius:8px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      flex:0 0 auto;
      object-fit:cover;
    }
    .dd-main{display:flex; flex-direction:column; min-width:0}
    .dd-title{font-weight:750; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .dd-sub{color:var(--muted); font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .badge{
      margin-left:auto;
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      background:rgba(255,255,255,.04);
      flex:0 0 auto;
      white-space:nowrap;
    }

    /* toggle vista */
    .view-toggle{
      display:flex;
      border:1px solid rgba(255,255,255,.14);
      border-radius:999px;
      overflow:hidden;
    }
    .view-toggle button{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:9px 12px;
      cursor:pointer;
      font-weight:750;
    }
    .view-toggle button.on{
      background:rgba(122,162,255,.22);
      color:var(--text);
    }

    .sections{
      padding:16px;
      display:grid;
      gap:14px;
    }

    /* Lista view */
    .list{
      display:grid;
      gap:10px;
    }
    .card{
      display:flex;
      gap:12px;
      align-items:center;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20);
      cursor:pointer;
    }
    .card:hover{background:rgba(255,255,255,.04)}
    .card img{width:48px; height:70px; border-radius:10px; border:1px solid rgba(255,255,255,.10); object-fit:cover; background:rgba(255,255,255,.06)}
    .card .meta{min-width:0}
    .card .meta .t{font-weight:850; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .card .meta .a{color:var(--muted); font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .chip{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
      color:var(--muted);
      font-size:12px;
      flex:0 0 auto;
    }
    .dot{width:8px; height:8px; border-radius:50%;}
    .dot.read{background:var(--ok)}
    .dot.reading{background:var(--warn)}
    .dot.to_read{background:rgba(255,255,255,.35)}

    /* Modali base */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      z-index:10000;
      padding:22px;
    }
    .modal-backdrop.on{display:flex; align-items:center; justify-content:center;}
    .modal{
      width:min(980px, 100%);
      border-radius:20px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(14,18,26,.94);
      box-shadow:0 40px 120px rgba(0,0,0,.8);
      overflow:hidden;
      backdrop-filter: blur(12px);
    }
    .modal .mhead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      padding:16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .modal .mhead h2{margin:0; font-size:18px}
    .modal .mhead .sub{margin:6px 0 0; color:var(--muted); font-size:13px}
    .modal .mbody{padding:14px 16px 16px}
    .modal .mfoot{
      padding:12px 16px 16px;
      border-top:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Edizioni */
    .editions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      max-height:420px;
      overflow:auto;
      padding-right:4px;
    }
    @media (max-width: 820px){
      .editions{grid-template-columns:1fr}
    }
    .edition{
      display:flex;
      gap:12px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      cursor:pointer;
      align-items:center;
    }
    .edition:hover{background:rgba(255,255,255,.05)}
    .edition.on{border-color:rgba(122,162,255,.55); box-shadow:0 0 0 3px rgba(122,162,255,.12)}
    .edition img{
      width:46px; height:66px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.10);
      object-fit:cover;
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .edition .e-meta{min-width:0}
    .edition .e-title{font-weight:850; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .edition .e-sub{color:var(--muted); font-size:12px; margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .edition .e-sub2{color:var(--muted); font-size:12px; margin-top:3px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}

    /* Toast */
    .toast{
      position:fixed;
      right:16px;
      bottom:16px;
      background:rgba(14,18,26,.92);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 20px 70px rgba(0,0,0,.6);
      border-radius:14px;
      padding:10px 12px;
      color:var(--text);
      font-size:13px;
      display:none;
      z-index:20000;
      max-width:min(420px, calc(100vw - 32px));
    }
    .toast.on{display:block}
    .toast .t2{color:var(--muted); font-size:12px; margin-top:3px}

    .smallnote{
      font-size:12px;
      color:var(--muted);
      margin-top:10px;
    }

    /* -------- STANZA INTERATTIVA (SCENE) -------- */
    .scene{
      position:relative;
      width:100%;
      aspect-ratio: 16 / 7;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: rgba(0,0,0,.22);
      box-shadow: var(--shadow);
    }
    .scene-bg{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      filter:saturate(1.05) contrast(1.02);
      transform: scale(1.005);
    }
    .books-layer{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index:3;
    }

    /* libri nella scena */
    .room-book{
      position:absolute;
      pointer-events:auto;
      cursor:pointer;
      border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 14px 40px rgba(0,0,0,.55);
      overflow:hidden;
      background: rgba(255,255,255,.06);
      transform-origin:center;
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .room-book:hover{ transform: translateY(-2px) scale(1.02); filter:brightness(1.04); }
    .room-book img{ width:100%; height:100%; object-fit:cover; display:block; }

    .room-book.vertical{ width:42px; height:140px; border-radius:10px; }
    .room-book.horizontal{ width:150px; height:44px; border-radius:12px; }
    .room-book.open{ width:180px; height:110px; border-radius:14px; }

    .room-book .fallback{
      width:100%; height:100%;
      display:flex; align-items:center; justify-content:center;
      font-size:11px; font-weight:850;
      color: rgba(255,255,255,.82);
      padding:8px;
      text-align:center;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.10));
    }

    /* overlay “fly to screen” */
    .focus-layer{
      position:fixed;
      inset:0;
      z-index:25000;
      pointer-events:none; /* abilitiamo solo sul pannello focus */
    }
    .focus-card{
      position:fixed;
      z-index:26000;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.16);
      box-shadow:0 50px 140px rgba(0,0,0,.85);
      background:rgba(14,18,26,.96);
      overflow:hidden;
      pointer-events:auto;
      opacity:0;
    }
    .focus-inner{
      display:flex;
      gap:14px;
      padding:14px;
      align-items:flex-start;
    }
    .focus-cover{
      width:180px;
      height:270px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      object-fit:cover;
      background:rgba(255,255,255,.06);
      flex:0 0 auto;
    }
    .focus-meta{min-width:0; flex:1;}
    .focus-title{font-weight:900; font-size:18px; margin:0;}
    .focus-sub{color:var(--muted); margin-top:6px; font-size:13px;}
    .focus-grid{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kv{border:1px solid rgba(255,255,255,.10); background:rgba(0,0,0,.20); border-radius:14px; padding:10px;}
    .kv .k{color:var(--muted); font-size:12px;}
    .kv .v{font-weight:850; margin-top:4px; font-size:13px;}
    .focus-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .focus-actions .btn{ padding:9px 11px; border-radius:12px; font-size:13px; }
    .focus-comment{
      margin-top:12px;
      border-top:1px solid rgba(255,255,255,.10);
      padding-top:10px;
      color:rgba(255,255,255,.90);
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
      max-height:150px;
      overflow:auto;
    }
    .focus-close{
      position:absolute;
      top:10px;
      right:10px;
    }

    /* in stanza: nascondi filtri/ricerca lista */
    .room-only{ display:none; }
    body.is-room .room-only{ display:inline-flex; }
    body.is-room .list-only{ display:none; }
  </style>
</head>

<body class="room-on">
  <div class="wrap">
    <header>
      <div class="title">
        <h1>Libreria</h1>
        <p>Gestione locale (localStorage). Lookup: Open Library. Vista “Stanza”: interattiva.</p>
      </div>
      <div class="top-actions">
        <div class="view-toggle" aria-label="toggle vista">
          <button id="btnList" class="on" type="button">Lista</button>
          <button id="btnRoom" type="button">Stanza</button>
        </div>
        <button class="btn small" id="btnExport" type="button">Esporta JSON</button>
        <button class="btn small" id="btnImport" type="button">Importa JSON</button>
        <button class="btn small danger" id="btnWipe" type="button">Svuota</button>
        <button class="btn small primary room-only" id="btnGoAdd" type="button">Aggiungi libro</button>
      </div>
    </header>

    <!-- FORM (usato per aggiungere/modificare): in stanza lo lasciamo, ma lo raggiungi col bottone -->
    <div class="panel pad formpanel list-only" id="formPanel">
      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:12px;">
        <div class="pill" id="stats">Totale: 0</div>
        <div class="row">
          <span class="pill" id="lookupState">Lookup ON</span>
          <button class="btn small ghost" type="button" id="btnToggleLookup">Disattiva lookup</button>
        </div>
      </div>

      <div class="grid form" style="margin-top:12px;">
        <div class="lookup-wrap">
          <label for="q">Cerca libro o autore *</label>
          <input id="q" autocomplete="off" placeholder="es. Demian, Hesse, Orwell, Calvino…"/>
          <div class="dropdown" id="dropdown">
            <div class="head">
              <span id="ddTitle">Suggerimenti (Open Library)</span>
              <span class="pill" style="padding:6px 10px; font-size:11px;">↑↓ invio · esc</span>
            </div>
            <div class="dd-list" id="ddList"></div>
          </div>
          <div class="hint" id="lookupHint">Digita almeno 2 caratteri. Seleziona un risultato per compilare titolo/autore e (opzionale) scegliere l’edizione.</div>
        </div>

        <div>
          <label for="status">Stato *</label>
          <select id="status">
            <option value="to_read">Da leggere</option>
            <option value="reading">In lettura</option>
            <option value="read">Letto</option>
          </select>
        </div>

        <div>
          <label for="rating">Valutazione (0–5)</label>
          <select id="rating">
            <option value="">—</option>
            <option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
          </select>
        </div>

        <div>
          <label for="comment">Commento / recensione (consigliato per “letti”)</label>
          <textarea id="comment" placeholder="Cosa ti ha lasciato? Punti chiave, impressioni, perché vale (o no)."></textarea>
        </div>
      </div>

      <div class="row" style="margin-top:12px; justify-content:space-between;">
        <div class="row">
          <button class="btn primary" id="btnSave" type="button">Salva</button>
          <button class="btn" id="btnPickEdition" type="button" style="display:none;">Scegli edizione</button>
          <button class="btn" id="btnClearForm" type="button">Pulisci</button>
        </div>
        <div class="row">
          <label style="display:flex; gap:8px; align-items:center; margin:0; color:var(--muted); font-size:12px;">
            <input type="checkbox" id="preferItalian" checked style="width:auto;"/>
            preferisci risultati in italiano (quando possibile)
          </label>
          <label style="display:flex; gap:8px; align-items:center; margin:0; color:var(--muted); font-size:12px;">
            <input type="checkbox" id="onlyItalianEditions" checked style="width:auto;"/>
            mostra solo edizioni in italiano (se disponibili)
          </label>
        </div>
      </div>

      <div class="smallnote">
        Nota: se la tendina “sparisce sotto”, era l’overflow del pannello: ora è risolto.
      </div>
    </div>

    <!-- LISTA -->
    <div class="panel listpanel list-only" style="margin-top:14px;">
      <div class="sections" id="viewList">
        <div class="row" style="justify-content:space-between;">
          <div class="row" style="gap:12px;">
            <div>
              <label for="localFilter">Filtro locale</label>
              <input id="localFilter" placeholder="filtra per titolo, autore, commento…"/>
            </div>
            <div>
              <label for="orderBy">Ordina</label>
              <select id="orderBy">
                <option value="updated_desc">Ultima modifica (↓)</option>
                <option value="updated_asc">Ultima modifica (↑)</option>
                <option value="title_asc">Titolo (A→Z)</option>
                <option value="title_desc">Titolo (Z→A)</option>
              </select>
            </div>
          </div>
        </div>
        <div class="list" id="list"></div>
      </div>
    </div>

    <!-- STANZA (scene) -->
    <div class="panel pad" id="viewRoom" style="margin-top:14px; display:none;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="pill" id="roomStats">Stanza: 0 libri</div>
        <div class="row">
          <span class="pill muted">Clicca un libro per aprire (zoom)</span>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="scene" id="scene">
          <img class="scene-bg" src="./assets/room.jpg" alt="Stanza" />
          <div class="books-layer" id="roomRead"></div>
          <div class="books-layer" id="roomReading"></div>
          <div class="books-layer" id="roomToRead"></div>
        </div>
      </div>

      <div class="smallnote" style="margin-top:10px;">
        In “Stanza” non c’è ricerca: è solo visualizzazione interattiva. Per aggiungere/modificare usa la vista “Lista” oppure il pulsante “Aggiungi libro”.
      </div>
    </div>
  </div>

  <!-- MODAL: Edizioni -->
  <div class="modal-backdrop" id="edModal">
    <div class="modal">
      <div class="mhead">
        <div>
          <h2>Scegli edizione</h2>
          <div class="sub" id="edSub">—</div>
        </div>
        <button class="btn small" id="edClose" type="button">✕</button>
      </div>
      <div class="mbody">
        <div class="row" style="justify-content:space-between; gap:10px; margin-bottom:10px;">
          <div class="pill" id="edInfo">—</div>
          <button class="btn small ghost" id="edReload" type="button">Ricarica edizioni</button>
        </div>
        <div class="editions" id="edList"></div>
        <div class="hint" id="edHint" style="margin-top:10px;"></div>
      </div>
      <div class="mfoot">
        <button class="btn" id="edSkip" type="button">Usa work (senza edizione)</button>
        <button class="btn primary" id="edUse" type="button">Usa questa edizione</button>
      </div>
    </div>
  </div>

  <!-- Overlay focus (zoom) -->
  <div class="focus-layer" id="focusLayer" style="display:none;"></div>
  <div class="focus-card" id="focusCard" aria-hidden="true">
    <button class="btn small focus-close" id="focusClose" type="button">✕</button>
    <div class="focus-inner">
      <img id="focusCover" class="focus-cover" alt="">
      <div class="focus-meta">
        <div class="focus-title" id="focusTitle">—</div>
        <div class="focus-sub" id="focusAuthor">—</div>

        <div class="focus-grid">
          <div class="kv"><div class="k">Stato</div><div class="v" id="focusStatus">—</div></div>
          <div class="kv"><div class="k">Valutazione</div><div class="v" id="focusRating">—</div></div>
          <div class="kv"><div class="k">Edizione</div><div class="v" id="focusEdition">—</div></div>
          <div class="kv"><div class="k">Aggiornato</div><div class="v" id="focusUpdated">—</div></div>
        </div>

        <div class="focus-actions">
          <button class="btn" id="focusCycle" type="button">Cambia stato</button>
          <button class="btn danger" id="focusDelete" type="button">Elimina</button>
          <button class="btn" id="focusOpenLibrary" type="button">Open Library</button>
          <button class="btn" id="focusAudible" type="button">Audible</button>
          <button class="btn" id="focusKindle" type="button">Kindle</button>
        </div>

        <div class="focus-comment" id="focusComment"></div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">
    <div id="toast1">—</div>
    <div class="t2" id="toast2"></div>
  </div>

<script>
(() => {
  const LS_KEY = "libreria.books.v3";

  // DOM
  const q = document.getElementById("q");
  const dropdown = document.getElementById("dropdown");
  const ddList = document.getElementById("ddList");
  const ddTitle = document.getElementById("ddTitle");

  const statusEl = document.getElementById("status");
  const ratingEl = document.getElementById("rating");
  const commentEl = document.getElementById("comment");

  const preferItalianEl = document.getElementById("preferItalian");
  const onlyItalianEditionsEl = document.getElementById("onlyItalianEditions");

  const btnSave = document.getElementById("btnSave");
  const btnClearForm = document.getElementById("btnClearForm");
  const btnPickEdition = document.getElementById("btnPickEdition");
  const stats = document.getElementById("stats");

  const lookupState = document.getElementById("lookupState");
  const btnToggleLookup = document.getElementById("btnToggleLookup");
  const lookupHint = document.getElementById("lookupHint");

  const btnExport = document.getElementById("btnExport");
  const btnImport = document.getElementById("btnImport");
  const btnWipe = document.getElementById("btnWipe");

  const btnList = document.getElementById("btnList");
  const btnRoom = document.getElementById("btnRoom");
  const viewList = document.getElementById("viewList");
  const viewRoom = document.getElementById("viewRoom");
  const formPanel = document.getElementById("formPanel");
  const btnGoAdd = document.getElementById("btnGoAdd");

  const localFilter = document.getElementById("localFilter");
  const orderBy = document.getElementById("orderBy");
  const listEl = document.getElementById("list");

  // Scene stanza
  const roomStats = document.getElementById("roomStats");
  const roomRead = document.getElementById("roomRead");
  const roomReading = document.getElementById("roomReading");
  const roomToRead = document.getElementById("roomToRead");

  // Edizioni modal
  const edModal = document.getElementById("edModal");
  const edSub = document.getElementById("edSub");
  const edInfo = document.getElementById("edInfo");
  const edList = document.getElementById("edList");
  const edHint = document.getElementById("edHint");
  const edClose = document.getElementById("edClose");
  const edReload = document.getElementById("edReload");
  const edSkip = document.getElementById("edSkip");
  const edUse = document.getElementById("edUse");

  // Focus overlay
  const focusLayer = document.getElementById("focusLayer");
  const focusCard = document.getElementById("focusCard");
  const focusClose = document.getElementById("focusClose");
  const focusCover = document.getElementById("focusCover");
  const focusTitle = document.getElementById("focusTitle");
  const focusAuthor = document.getElementById("focusAuthor");
  const focusStatus = document.getElementById("focusStatus");
  const focusRating = document.getElementById("focusRating");
  const focusEdition = document.getElementById("focusEdition");
  const focusUpdated = document.getElementById("focusUpdated");
  const focusComment = document.getElementById("focusComment");
  const focusCycle = document.getElementById("focusCycle");
  const focusDelete = document.getElementById("focusDelete");
  const focusOpenLibrary = document.getElementById("focusOpenLibrary");
  const focusAudible = document.getElementById("focusAudible");
  const focusKindle = document.getElementById("focusKindle");

  // Toast
  const toast = document.getElementById("toast");
  const toast1 = document.getElementById("toast1");
  const toast2 = document.getElementById("toast2");

  // Stato app
  let books = loadBooks();
  let view = loadView();
  let lookupOn = loadLookup();
  let lookupAbort = null;
  let ddItems = [];
  let ddIndex = -1;

  // Lookup selection
  let selectedWork = null;     // {workKey, title, author, coverUrl, editionCount}
  let editionsCache = null;
  let selectedEdition = null;  // {editionKey, publishDate, publisher, language, coverUrl}

  // editing
  let editingId = null;

  // focus open id
  let focusId = null;

  // -------- Utils ----------
  function nowISO(){ return new Date().toISOString(); }
  function fmtDate(iso){
    try{ return new Date(iso).toLocaleString("it-IT"); }
    catch{ return iso; }
  }
  function toastMsg(t1, t2=""){
    toast1.textContent = t1;
    toast2.textContent = t2;
    toast.classList.add("on");
    setTimeout(() => toast.classList.remove("on"), 2600);
  }

  function loadBooks(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function saveBooks(){ localStorage.setItem(LS_KEY, JSON.stringify(books)); }

  function loadView(){ return localStorage.getItem("libreria.view") || "list"; }
  function saveView(){ localStorage.setItem("libreria.view", view); }

  function loadLookup(){
    const v = localStorage.getItem("libreria.lookup");
    return v === null ? true : v === "1";
  }
  function saveLookup(){ localStorage.setItem("libreria.lookup", lookupOn ? "1" : "0"); }

  function loadOnlyItalianEditions(){
    const v = localStorage.getItem("libreria.onlyItalianEditions");
    return v === null ? true : v === "1";
  }
  function saveOnlyItalianEditions(){
    localStorage.setItem("libreria.onlyItalianEditions", onlyItalianEditionsEl.checked ? "1" : "0");
  }

  function statusLabel(s){
    if(s==="read") return "Letto";
    if(s==="reading") return "In lettura";
    return "Da leggere";
  }
  function statusDotClass(s){
    if(s==="read") return "read";
    if(s==="reading") return "reading";
    return "to_read";
  }
  function normalize(s){ return (s||"").toLowerCase().trim(); }

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function escapeAttr(str){ return escapeHtml(str).replaceAll("\n", " "); }

  function cryptoRandomId(){
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now();
  }

  function coverFromDoc(doc){
    if(doc.cover_i) return `https://covers.openlibrary.org/b/id/${doc.cover_i}-M.jpg`;
    return "";
  }
  function coverFromEdition(ed){
    const olid = (ed.key || "").split("/").pop();
    if(ed.covers && ed.covers.length){
      return `https://covers.openlibrary.org/b/id/${ed.covers[0]}-M.jpg`;
    }
    if(olid && olid.startsWith("OL")){
      return `https://covers.openlibrary.org/b/olid/${olid}-M.jpg`;
    }
    return "";
  }

  function guessAuthorFromFreeText(text){
    const s = text.trim();
    const m = s.match(/(.+?)(?:\s[-,–]\s)(.+)$/);
    if(m) return m[2].trim();
    return "";
  }

  // -------- View toggle ----------
  function applyView(){
    if(view === "room"){
      btnRoom.classList.add("on"); btnList.classList.remove("on");
            viewRoom.style.display = "block";
      document.body.classList.add("is-room");
      renderRoom();
    } else {
      btnList.classList.add("on"); 
      btnRoom.classList.remove("on");
      viewRoom.style.display = "none";
      document.body.classList.remove("is-room");
      renderList();
    }
    saveView();
    updateStats();
  }

  // -------- Stats ----------
  function updateStats(){
    const total = books.length;
    const read = books.filter(b => b.status === "read").length;
    const reading = books.filter(b => b.status === "reading").length;
    const toRead = books.filter(b => b.status === "to_read").length;

    stats.textContent = `Totale: ${total} · Letti: ${read} · In lettura: ${reading} · Da leggere: ${toRead}`;
    roomStats.textContent = `Stanza: ${total} libri`;
  }

  // -------- Init + bind ----------
  function init(){
    preferItalianEl.checked = loadPreferItalian();
    onlyItalianEditionsEl.checked = loadOnlyItalianEditions();
    setLookupUI();
    bindEvents();
    applyView();
  }

  init();
})();
</script>
</body>
</html>

