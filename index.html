<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Libreria 4.0 - True 3D Environment</title>
  
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Inter:wght@400;600&family=Libre+Baskerville:ital@0;1&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --wall-color: #1a1a1a;
      --floor-dark: #2d1b0e;
      --floor-light: #3e2716;
      --wood: #5c4033;
      --accent: #d4af37;
    }

    body {
      margin: 0; overflow: hidden; background: #000;
      font-family: 'Inter', sans-serif; color: white;
      height: 100vh; width: 100vw;
      perspective: 1500px; /* La profondità della telecamera */
    }

    /* --- INTERFACCIA UI (Sopra al 3D) --- */
    .ui-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      pointer-events: none; z-index: 100;
    }
    
    .ui-header {
      padding: 20px; display: flex; justify-content: space-between; align-items: center;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
      pointer-events: auto;
    }
    
    h1 { font-family: 'Cinzel', serif; color: var(--accent); margin: 0; text-shadow: 0 2px 10px black; }
    
    .btn {
      background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
      color: white; padding: 10px 20px; border-radius: 6px; cursor: pointer;
      font-weight: 600; backdrop-filter: blur(5px); transition: .2s;
    }
    .btn:hover { background: var(--accent); color: black; }

    /* PANNELLO LATERALE GESTIONE */
    .panel {
      position: absolute; top: 0; right: 0; bottom: 0; width: 400px;
      background: rgba(15, 15, 20, 0.95); border-left: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(15px); padding: 25px;
      transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
      pointer-events: auto; overflow-y: auto; display: flex; flex-direction: column; gap: 20px;
    }
    .panel.open { transform: translateX(0); }

    /* INPUTS */
    .input-group label { display: block; font-size: 11px; text-transform: uppercase; color: #888; margin-bottom: 5px; }
    input, select, textarea {
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid #444;
      color: white; padding: 12px; border-radius: 6px; font-family: inherit; margin-bottom: 10px;
    }
    input:focus { border-color: var(--accent); outline: none; }

    /* RISULTATI RICERCA */
    .search-res {
      background: #000; border: 1px solid #333; border-radius: 6px;
      max-height: 0; overflow: hidden; transition: max-height 0.3s;
    }
    .search-res.active { max-height: 200px; overflow-y: auto; border-color: var(--accent); }
    .res-item { padding: 10px; border-bottom: 1px solid #222; cursor: pointer; display: flex; gap: 10px; }
    .res-item:hover { background: #222; }

    /* --- MOTORE 3D (La Stanza) --- */
    .scene {
      width: 100%; height: 100%;
      transform-style: preserve-3d;
      transform: translateZ(-200px); /* Allontana un po' la scena */
      transition: transform 0.1s; /* Fluidità movimento mouse */
    }

    .room {
      position: absolute; top: 50%; left: 50%;
      width: 0; height: 0;
      transform-style: preserve-3d;
    }

    /* PAVIMENTO (Generato proceduralmente) */
    .floor {
      position: absolute; top: 200px; left: -1000px; width: 2000px; height: 2000px;
      background: repeating-linear-gradient(
        90deg, 
        var(--floor-dark) 0px, var(--floor-dark) 48px, 
        #111 49px, #111 50px
      );
      transform: rotateX(90deg);
      box-shadow: inset 0 0 500px black;
    }

    /* MURO DI FONDO */
    .wall-back {
      position: absolute; top: -1000px; left: -1000px; width: 2000px; height: 1200px;
      background: var(--wall-color);
      transform: translateZ(-500px);
      box-shadow: inset 0 0 200px black;
    }

    /* --- MOBILI 3D --- */
    
    /* SCAFFALE (Contenitore 3D) */
    .bookshelf {
      position: absolute; transform-style: preserve-3d;
      width: 800px; height: 20px;
      background: var(--wood);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    }
    .shelf-1 { top: -200px; left: -400px; transform: translateZ(-480px); }
    .shelf-2 { top: 0px; left: -400px; transform: translateZ(-480px); }
    .shelf-3 { top: 200px; left: -400px; transform: translateZ(-480px); }

    /* TAVOLO (Al centro della stanza) */
    .table-top {
      position: absolute; width: 400px; height: 250px;
      background: #3e2723;
      top: 150px; left: -200px;
      transform: rotateX(90deg) translateZ(100px); /* Altezza tavolo */
      transform-style: preserve-3d;
      box-shadow: 0 50px 100px rgba(0,0,0,0.9);
      display: flex; align-items: center; justify-content: center;
    }
    /* Gambe tavolo */
    .leg {
      position: absolute; width: 20px; height: 200px; background: #2d1b0e;
      transform: rotateX(-90deg); top: 20px;
    }
    .l1 { left: 20px; } .l2 { right: 20px; } 
    .l3 { left: 20px; top: 210px; } .l4 { right: 20px; top: 210px; }

    /* --- LIBRI 3D --- */
    .book {
      position: absolute; transform-style: preserve-3d; cursor: pointer;
      transition: transform 0.3s;
    }
    
    /* Facce del libro */
    .face { position: absolute; backface-visibility: hidden; }
    .f-spine { width: 100%; height: 100%; background: #444; border-radius: 2px; }
    .f-cover { width: 100%; height: 100%; background: #333; transform: rotateY(90deg); transform-origin: left; }
    .f-side  { width: 100%; height: 100%; background: #eee; transform: rotateY(-90deg); transform-origin: right; }
    
    /* TIPO A: SULLO SCAFFALE (Verticale) */
    .book-shelf {
      width: 25px; height: 140px; bottom: 20px;
      transform-origin: bottom center;
    }
    .book-shelf:hover { transform: translateZ(30px); }
    .book-shelf .f-spine { 
      display: flex; align-items: center; justify-content: center;
      writing-mode: vertical-rl; font-size: 9px; color: #ccc;
      text-shadow: 0 1px 2px black; font-family: 'Libre Baskerville';
      box-shadow: inset 2px 0 5px rgba(0,0,0,0.5);
    }
    
    /* TIPO B: SUL TAVOLO (Piatto) */
    .book-table {
      width: 140px; height: 200px;
      transform: rotateX(-90deg) translateZ(10px); /* Appoggiato */
    }
    .book-table:hover { transform: rotateX(-90deg) translateZ(40px); } /* Solleva */
    .book-table .f-cover { 
      position: absolute; width: 100%; height: 100%; top:0; left:0;
      transform: none; /* Copertina frontale */
    }
    
    /* TIPO C: WISHLIST (Pila a terra) */
    .book-floor {
      width: 130px; height: 190px;
      transform: rotateX(-90deg);
    }

    /* DETTAGLIO MODAL */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2000;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    .modal-overlay.active { display: flex; }
    .modal-card {
      background: #151515; border: 1px solid #444; padding: 30px; border-radius: 12px;
      width: 500px; display: grid; grid-template-columns: 140px 1fr; gap: 20px;
      box-shadow: 0 50px 100px black;
    }
    
    /* Helper colors */
    .bk-red { background: #7f1d1d; }
    .bk-blue { background: #1e3a8a; }
    .bk-green { background: #14532d; }
    .bk-black { background: #171717; }
  </style>
</head>
<body>

<div class="ui-layer">
  <div class="ui-header">
    <h1>BIBLIOTHECA <span style="font-size:12px; opacity:0.6;">4.0 // 3D VIRTUAL</span></h1>
    <button class="btn" onclick="togglePanel()">+ GESTISCI LIBRI</button>
  </div>
</div>

<div class="panel" id="sidePanel">
  <div style="display:flex; justify-content:space-between;">
    <h2>Aggiungi Libro</h2>
    <button class="btn" onclick="togglePanel()" style="padding:5px 10px;">✕</button>
  </div>

  <div class="input-group">
    <label>Ricerca Google Books (Italiano)</label>
    <input id="inpSearch" placeholder="Es. Dostoevskij, Calvino..." autocomplete="off">
    <div class="search-res" id="resBox"></div>
  </div>

  <hr style="border-color:#333; width:100%;">

  <div class="input-group">
    <label>Titolo</label>
    <input id="inpTitle" placeholder="Inserimento manuale se vuoto">
  </div>
  
  <div style="display:flex; gap:10px;">
    <div class="input-group" style="flex:1">
      <label>Autore</label>
      <input id="inpAuthor">
    </div>
    <div class="input-group" style="width:80px">
      <label>Pagine</label>
      <input id="inpPages" type="number" value="200">
    </div>
  </div>

  <div class="input-group">
    <label>Stato (Dove lo mettiamo?)</label>
    <select id="inpStatus">
      <option value="reading">In Lettura (Sul Tavolo)</option>
      <option value="read">Letto (Scaffale Alto)</option>
      <option value="toread">Da Leggere (Scaffale Basso)</option>
      <option value="wishlist">Wishlist (Pila a Terra)</option>
    </select>
  </div>

  <div class="input-group">
    <label>Colore Rilegatura</label>
    <select id="inpColor">
      <option value="bk-red">Rosso</option>
      <option value="bk-blue">Blu</option>
      <option value="bk-green">Verde</option>
      <option value="bk-black">Nero</option>
    </select>
  </div>
  
  <div class="input-group">
    <label>Recensione / Note</label>
    <textarea id="inpNote" rows="3"></textarea>
  </div>

  <button class="btn" style="background:var(--accent); color:black; width:100%;" onclick="saveBook()">SALVA NELLA STANZA</button>
</div>

<div class="scene" id="scene3d">
  <div class="room">
    <div class="wall-back"></div>
    <div class="floor"></div>

    <div class="bookshelf shelf-1" id="zone-read"></div>
    
    <div class="bookshelf shelf-2" id="zone-toread"></div>
    
    <div class="bookshelf shelf-3" id="zone-extra"></div>

    <div class="table-top" id="zone-reading">
      <div class="leg l1"></div><div class="leg l2"></div>
      <div class="leg l3"></div><div class="leg l4"></div>
      </div>

    <div style="position:absolute; top:200px; left:400px; transform:translateZ(-400px);" id="zone-wishlist"></div>

  </div>
</div>

<div class="modal-overlay" id="modal" onclick="if(event.target===this) closeModal()">
  <div class="modal-card">
    <img id="m-cover" style="width:100%; border-radius:6px;">
    <div>
      <h2 id="m-title" style="color:var(--accent); margin-top:0;">Titolo</h2>
      <p id="m-author" style="color:#888;">Autore</p>
      <div id="m-note" style="background:#222; padding:10px; border-radius:6px; font-style:italic; margin:10px 0;"></div>
      <button class="btn" style="background:#422; border-color:#633;" onclick="deleteBook()">Elimina Libro</button>
    </div>
  </div>
</div>

<script>
// --- DATI ---
const LS_KEY = "lib_v4_3d";
let books = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
let tempCover = "";
let focusId = null;

// --- INTERAZIONE MOUSE (PARALLASSE 3D) ---
document.addEventListener('mousemove', (e) => {
  const x = (window.innerWidth / 2 - e.clientX) / 50; // Rotazione Y
  const y = (window.innerHeight / 2 - e.clientY) / 50; // Rotazione X
  
  const scene = document.getElementById('scene3d');
  // Limita la rotazione per non capovolgere la stanza
  scene.style.transform = `translateZ(-200px) rotateY(${x}deg) rotateX(${-y/2}deg)`;
});

// --- GOOGLE BOOKS API (Con Timeout di sicurezza) ---
const inpSearch = document.getElementById('inpSearch');
const resBox = document.getElementById('resBox');
let timer;

inpSearch.addEventListener('input', (e) => {
  clearTimeout(timer);
  const q = e.target.value.trim();
  if(q.length < 3) { resBox.classList.remove('active'); return; }

  timer = setTimeout(async () => {
    // Timeout Promise
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 2000); // 2 sec max

    try {
      const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&langRestrict=it&maxResults=5&printType=books`;
      const req = await fetch(url, { signal: controller.signal });
      const data = await req.json();
      
      if(data.items) {
        resBox.innerHTML = data.items.map(i => {
          const info = i.volumeInfo;
          return `<div class="res-item" onclick='selectApiBook(${JSON.stringify(i).replace(/'/g, "&apos;")})'>
            <div><b>${info.title}</b><br><small>${info.authors?.[0]||'?'}</small></div>
          </div>`;
        }).join('');
        resBox.classList.add('active');
      }
    } catch(err) {
      console.log("Ricerca fallita o timeout. Inserimento manuale attivo.");
    }
  }, 500);
});

function selectApiBook(data) {
  const info = data.volumeInfo;
  document.getElementById('inpTitle').value = info.title;
  document.getElementById('inpAuthor').value = info.authors?.[0] || "";
  document.getElementById('inpPages').value = info.pageCount || 200;
  tempCover = info.imageLinks?.thumbnail || "";
  resBox.classList.remove('active');
  document.getElementById('inpSearch').value = "";
}

// --- LOGICA LIBRI ---
function saveBook() {
  const title = document.getElementById('inpTitle').value;
  if(!title) return alert("Titolo obbligatorio!");

  const newBook = {
    id: crypto.randomUUID(),
    title: title,
    author: document.getElementById('inpAuthor').value,
    pages: document.getElementById('inpPages').value,
    status: document.getElementById('inpStatus').value,
    color: document.getElementById('inpColor').value,
    note: document.getElementById('inpNote').value,
    cover: tempCover,
    ts: Date.now()
  };

  books.push(newBook);
  localStorage.setItem(LS_KEY, JSON.stringify(books));
  render3D();
  
  // Pulisci form
  document.getElementById('inpTitle').value = "";
  document.getElementById('inpNote').value = "";
  tempCover = "";
}

function render3D() {
  // Svuota zone
  const zones = {
    reading: document.getElementById('zone-reading'),
    read: document.getElementById('zone-read'),
    toread: document.getElementById('zone-toread'),
    wishlist: document.getElementById('zone-wishlist')
  };
  Object.values(zones).forEach(z => z.innerHTML = (z.id === 'zone-reading' ? '<div class="leg l1"></div><div class="leg l2"></div><div class="leg l3"></div><div class="leg l4"></div>' : ''));

  books.forEach((b, idx) => {
    const el = document.createElement('div');
    el.onclick = (e) => { e.stopPropagation(); openModal(b.id); };
    
    // GENERAZIONE GEOMETRIA 3D
    if(b.status === 'read' || b.status === 'toread') {
      // Libro su scaffale (Dorso visibile)
      el.className = 'book book-shelf';
      // Spostiamo i libri lungo lo scaffale
      const offset = (idx % 15) * 30 + 20; // 30px per libro
      el.style.left = offset + 'px';
      
      // Colore dorso
      const color = getColorCode(b.color);
      
      el.innerHTML = `
        <div class="face f-spine" style="background:${color}">${b.title.substring(0,20)}</div>
        <div class="face f-side" style="width:25px;"></div>
      `;
      
      if(b.status === 'read') zones.read.appendChild(el);
      else zones.toread.appendChild(el);
    }
    else if(b.status === 'reading') {
      // Libro sul tavolo (Piatto)
      el.className = 'book book-table';
      
      el.innerHTML = `
        <div class="face f-cover" style="background:url('${b.cover || ''}') center/cover #333;">
           ${!b.cover ? `<div style="padding:20px; color:white;">${b.title}</div>` : ''}
        </div>
        <div class="face" style="width:140px; height:20px; background:#eee; top:200px; transform:rotateX(-90deg); transform-origin:top;"></div>
      `;
      zones.reading.appendChild(el);
    }
    else if(b.status === 'wishlist') {
        // Pila a terra
        el.className = 'book book-floor';
        // Impiliamo verticalmente
        const stackH = (idx % 5) * 20;
        el.style.transform = `translateY(-${stackH}px) rotateX(-90deg)`;
        
        el.innerHTML = `<div class="face f-cover" style="background:url('${b.cover}') center/cover #555;"></div>`;
        zones.wishlist.appendChild(el);
    }
  });
}

function getColorCode(cls) {
  if(cls === 'bk-red') return '#7f1d1d';
  if(cls === 'bk-blue') return '#1e3a8a';
  if(cls === 'bk-green') return '#14532d';
  return '#171717';
}

// --- UI HELPERS ---
function togglePanel() {
  document.getElementById('sidePanel').classList.toggle('open');
}

function openModal(id) {
  focusId = id;
  const b = books.find(x => x.id === id);
  document.getElementById('m-title').innerText = b.title;
  document.getElementById('m-author').innerText = b.author;
  document.getElementById('m-note').innerText = b.note || "Nessuna nota.";
  document.getElementById('m-cover').src = b.cover || "";
  document.getElementById('modal').classList.add('active');
}

function closeModal() {
  document.getElementById('modal').classList.remove('active');
}

function deleteBook() {
  if(!confirm("Eliminare?")) return;
  books = books.filter(b => b.id !== focusId);
  localStorage.setItem(LS_KEY, JSON.stringify(books));
  closeModal();
  render3D();
}

// Init
render3D();
// Apri pannello se vuoto
if(books.length === 0) setTimeout(togglePanel, 500);

</script>
</body>
</html>
