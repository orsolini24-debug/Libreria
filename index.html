<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Libreria 7.2 - Stable Core</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">

<style>
    :root {
        --c-accent: #fbbf24;
        --c-dark: #020617;
        --c-panel: rgba(15, 23, 42, 0.98);
        --c-border: 1px solid rgba(255,255,255,0.15);
    }
    
    * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
    
    body { 
        margin: 0; height: 100vh; overflow: hidden; 
        background: var(--c-dark); color: #fff; font-family: 'Inter', sans-serif;
    }

    /* SCENA 3D */
    #viewport { 
        position: relative; width: 100vw; height: 100vh; 
        perspective: 1500px; overflow: hidden; 
    }
    
    #room-bg { 
        position: absolute; inset: 0; width: 100%; height: 100%; 
        object-fit: cover; z-index: 0; filter: brightness(0.6); transform: scale(1.05); 
        pointer-events: none;
    }

    #scene-layer { 
        position: absolute; inset: 0; z-index: 10; transform-style: preserve-3d; pointer-events: none;
    }
    /* Le zone ora hanno pointer-events:auto per catturare i click sui libri */
    .zone { position: absolute; pointer-events: auto; }

    /* POSIZIONI */
    #zone-read { top: 13%; left: 47%; width: 28%; height: 14%; display: flex; align-items: flex-end; gap: 3px; }
    #zone-toread { top: 31%; left: 47%; width: 28%; height: 14%; display: flex; align-items: flex-end; gap: 3px; }
    #zone-reading { bottom: 15%; left: 20%; width: 40%; height: 30%; display: flex; align-items: center; justify-content: center; perspective: 800px; z-index: 20; }
    #zone-wishlist { bottom: 5%; right: 5%; width: 15%; height: 15%; z-index: 20; }

    /* UI TOP */
    .ui-top { 
        position: absolute; top: 0; left: 0; width: 100%; padding: 20px; 
        display: flex; justify-content: space-between; z-index: 100; 
        background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); 
        pointer-events: none; 
    }
    .ui-top * { pointer-events: auto; }

    .btn { 
        padding: 10px 18px; border-radius: 8px; border: var(--c-border); 
        background: rgba(30, 41, 59, 0.8); color: #fff; cursor: pointer; 
        font-weight: 600; font-size: 13px; backdrop-filter: blur(4px);
        transition: transform 0.1s;
    }
    .btn:active { transform: scale(0.95); }
    .btn-primary { background: var(--c-accent); color: #000; border: none; }
    .btn-danger { background: rgba(220, 38, 38, 0.2); border-color: #ef4444; color: #fca5a5; }

    /* PANNELLO LATERALE */
    #side-panel {
        position: fixed; top: 0; right: 0; bottom: 0; width: 450px; max-width: 100%;
        background: var(--c-panel); border-left: var(--c-border);
        transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        z-index: 2000; padding: 30px; display: flex; flex-direction: column; gap: 15px; 
        overflow-y: auto; box-shadow: -10px 0 50px rgba(0,0,0,0.8);
    }
    #side-panel.open { transform: translateX(0); }

    /* RICERCA */
    .search-wrapper { position: relative; z-index: 3000; }
    label { font-size: 11px; text-transform: uppercase; color: var(--c-accent); font-weight: 700; margin-bottom: 5px; display: block; }
    input, select, textarea { 
        width: 100%; background: rgba(0,0,0,0.4); border: 1px solid #334155; 
        padding: 12px; color: #fff; border-radius: 6px; font-family: inherit;
    }
    input:focus { border-color: var(--c-accent); background: rgba(0,0,0,0.6); }

    #search-status { 
        font-size: 11px; margin-top: 5px; min-height: 15px; 
        color: #94a3b8; font-style: italic; 
    }

    #search-results {
        position: absolute; top: 100%; left: 0; right: 0; margin-top: 5px;
        background: #0f172a; border: 1px solid var(--c-accent); border-radius: 6px;
        max-height: 0; overflow: hidden; transition: 0.2s;
        box-shadow: 0 20px 50px rgba(0,0,0,1);
    }
    #search-results.active { max-height: 300px; overflow-y: auto; }
    
    .res-item { display: flex; gap: 12px; padding: 12px; cursor: pointer; border-bottom: 1px solid #1e293b; transition: background 0.2s; }
    .res-item:hover { background: #1e293b; }
    .res-img { width: 40px; height: 60px; object-fit: cover; background: #333; border-radius: 3px; }

    /* LIBRI 3D */
    .spine { 
        width: 28px; height: 90%; background: #444; border-radius: 2px; 
        cursor: pointer; position: relative; transition: 0.2s; 
        box-shadow: 2px 0 5px rgba(0,0,0,0.6); 
    }
    .spine:hover { transform: scale(1.1) translateZ(10px); z-index: 100; }
    .spine-txt { 
        writing-mode: vertical-rl; position: absolute; inset:0; 
        display:flex; align-items:center; justify-content:center; 
        font-size: 9px; color: rgba(255,255,255,0.8); letter-spacing: 1px;
    }

    .book-3d {
        width: 140px; height: 210px; position: relative;
        transform-style: preserve-3d; cursor: pointer; transition: 0.4s;
        transform: rotateX(40deg) rotateZ(-10deg);
        box-shadow: -15px 30px 40px rgba(0,0,0,0.6);
    }
    .book-3d:hover { transform: rotateX(0deg) rotateZ(0deg) scale(1.1) translateZ(50px); z-index: 1000; box-shadow: 0 50px 100px rgba(0,0,0,0.8); }
    
    .b-face { position: absolute; backface-visibility: hidden; }
    .b-front { 
        inset: 0; background: #333; transform: translateZ(12px); 
        border-radius: 2px 5px 5px 2px; background-size: cover; background-position: center;
        box-shadow: inset 2px 0 10px rgba(0,0,0,0.5);
    }
    .b-side { 
        right: 0; width: 24px; height: 100%; background: #e2e8f0; 
        transform: rotateY(90deg) translateZ(-1px); transform-origin: right; 
    }
    .b-bottom { 
        bottom: 0; width: 100%; height: 24px; background: #cbd5e1; 
        transform: rotateX(-90deg) translateZ(0); transform-origin: bottom; 
    }

    /* MODALE */
    #modal-overlay { 
        position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 5000; 
        display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    #modal-overlay.active { display: flex; }
    
    .modal-box { 
        background: #1e293b; width: 500px; max-width: 90%; 
        padding: 30px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); 
        box-shadow: 0 0 50px rgba(0,0,0,0.8);
    }
    
    .links-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-top: 25px; }
    .link-btn { 
        background: #334155; padding: 12px; text-align: center; color: white; 
        text-decoration: none; border-radius: 6px; font-size: 12px; display: flex; 
        align-items: center; justify-content: center; gap: 6px; transition: 0.2s;
    }
    .link-btn:hover { background: #fff; color: #000; }
    .link-kindle { border-bottom: 2px solid #00a8e1; } /* Colore Kindle */
    .link-kindle:hover { background: #00a8e1; color: white; }

</style>
</head>
<body>

<div class="ui-top">
    <h2>Libreria 7.2 <span style="font-size:12px; color:#94a3b8; font-weight:400;">Stable Core</span></h2>
    <div style="display:flex; gap:10px">
        <button class="btn btn-danger" onclick="app.reset()">RESET DATI</button>
        <button class="btn btn-primary" onclick="ui.openPanel()">+ Aggiungi</button>
    </div>
</div>

<div id="viewport">
    <img src="./assets/room.jpg" id="room-bg" onerror="this.style.display='none'; document.body.style.background='#111'">
    
    <div id="scene-layer">
        <div class="zone" id="zone-shelf-high"></div>
        <div class="zone" id="zone-shelf-low"></div>
        <div class="zone" id="zone-reading"></div>
        <div class="zone" id="zone-wishlist"></div>
    </div>
</div>

<div id="side-panel">
    <div style="display:flex; justify-content:space-between; align-items:center">
        <h3>Gestisci Libro</h3>
        <button class="btn" onclick="ui.closePanel()">✕</button>
    </div>

    <div class="search-wrapper">
        <label>Cerca Libro (Google & OpenLibrary)</label>
        <input id="inpSearch" placeholder="Digita titolo..." autocomplete="off">
        <div id="search-status">In attesa...</div>
        <div id="search-results"></div>
    </div>

    <hr style="border-color:rgba(255,255,255,0.1); width:100%; margin: 20px 0;">

    <div style="display:flex; flex-direction:column; gap:15px;">
        <div>
            <label>Titolo *</label>
            <input id="inpTitle">
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div><label>Autore</label><input id="inpAuthor"></div>
            <div><label>Pagine</label><input type="number" id="inpPages" value="200"></div>
        </div>
        <div>
            <label>Stato</label>
            <select id="inpStatus">
                <option value="reading">In Lettura (Tavolo)</option>
                <option value="read">Letto (Scaffale Alto)</option>
                <option value="toread">Da Leggere (Scaffale Basso)</option>
                <option value="wishlist">Wishlist (Angolo)</option>
            </select>
        </div>
        <div>
            <label>Colore Dorso</label>
            <select id="inpColor">
                <option value="linear-gradient(45deg, #7f1d1d, #991b1b)">Rosso</option>
                <option value="linear-gradient(45deg, #1e3a8a, #1e40af)">Blu</option>
                <option value="linear-gradient(45deg, #14532d, #166534)">Verde</option>
                <option value="linear-gradient(45deg, #171717, #262626)">Nero</option>
            </select>
        </div>
        <div>
            <label>Note</label>
            <textarea id="inpNote" rows="3"></textarea>
        </div>
    </div>

    <button class="btn btn-primary" style="margin-top:20px; padding:15px;" onclick="app.save()">SALVA LIBRO</button>
</div>

<div id="modal-overlay">
    <div class="modal-box">
        <h2 id="m-title" style="color:var(--c-accent); margin-top:0; font-family:'Playfair Display'">Titolo</h2>
        <p id="m-author" style="color:#94a3b8; margin-top:-10px">Autore</p>
        
        <p id="m-note" style="background:rgba(0,0,0,0.3); padding:15px; border-radius:6px; font-style:italic; border-left:3px solid var(--c-accent);">...</p>
        
        <div class="links-grid">
            <a href="#" target="_blank" id="lnk-amazon" class="link-btn"><i class="fab fa-amazon"></i> Amazon</a>
            <a href="#" target="_blank" id="lnk-kindle" class="link-btn link-kindle"><i class="fas fa-tablet-alt"></i> Kindle Store</a>
            <a href="#" target="_blank" id="lnk-audible" class="link-btn"><i class="fas fa-headphones"></i> Audible</a>
        </div>

        <button class="btn" style="width:100%; margin-top:20px; border-color:#ef4444; color:#ef4444; background:transparent" onclick="app.delete()">Elimina Libro</button>
        <button class="btn" style="width:100%; margin-top:10px; background:transparent" onclick="ui.closeModal()">Chiudi</button>
    </div>
</div>

<script>
const DB_KEY = "lib_7_2_stable";
let books = [];
let tempCover = "";
let focusId = null;

// --- APP LOGIC ---
const app = {
    init: () => {
        try { books = JSON.parse(localStorage.getItem(DB_KEY) || "[]"); } catch { books=[]; }
        app.render();
    },
    save: () => {
        const t = document.getElementById('inpTitle').value;
        if(!t) return alert("Manca il titolo!");
        
        books.push({
            id: Date.now().toString(),
            title: t,
            author: document.getElementById('inpAuthor').value,
            status: document.getElementById('inpStatus').value,
            note: document.getElementById('inpNote').value,
            cover: tempCover,
            color: document.getElementById('inpColor').value,
            pages: document.getElementById('inpPages').value
        });
        localStorage.setItem(DB_KEY, JSON.stringify(books));
        
        // Reset
        document.getElementById('inpTitle').value = "";
        document.getElementById('inpNote').value = "";
        tempCover = "";
        ui.closePanel();
        app.render();
    },
    delete: () => {
        if(!confirm("Eliminare?")) return;
        books = books.filter(b => b.id !== focusId);
        localStorage.setItem(DB_KEY, JSON.stringify(books));
        ui.closeModal();
        app.render();
    },
    reset: () => {
        if(confirm("Cancellare TUTTO per riparare?")) {
            localStorage.removeItem(DB_KEY);
            location.reload();
        }
    },
    render: () => {
        ['zone-reading','zone-shelf-high','zone-shelf-low','zone-wishlist'].forEach(id => document.getElementById(id).innerHTML='');

        books.forEach(b => {
            const div = document.createElement('div');
            div.onclick = () => ui.openModal(b);

            // TAVOLO (3D)
            if(b.status === 'reading') {
                div.className = 'book-3d';
                // Copertina o Fallback generato
                const bg = b.cover ? `url('${b.cover}')` : b.color;
                const text = b.cover ? '' : `<div style="padding:10px; color:rgba(255,255,255,0.7); text-align:center; transform:rotateY(180deg)">${b.title}</div>`;
                
                div.innerHTML = `
                    <div class="b-face b-front" style="background:${bg}; background-size:cover;">${text}</div>
                    <div class="b-face b-side"></div>
                    <div class="b-face b-bottom"></div>`;
                document.getElementById('zone-reading').appendChild(div);
            }
            // SCAFFALI
            else if(b.status.includes('read')) {
                div.className = 'spine';
                div.style.background = b.color;
                // Altezza variabile
                div.style.height = (80 + (b.title.length % 20)) + '%';
                div.innerHTML = `<div class="spine-txt">${b.title}</div>`;
                const dest = b.status==='read' ? 'zone-shelf-high' : 'zone-shelf-low';
                document.getElementById(dest).appendChild(div);
            }
            // WISHLIST
            else {
                div.style.cssText = `position:absolute; width:60px; height:80px; background:#fff; color:#000; font-size:9px; padding:5px; transform:rotate(${Math.random()*20-10}deg); box-shadow:0 5px 10px #000; cursor:pointer; text-align:center; overflow:hidden; border:1px solid #ccc;`;
                div.innerHTML = b.cover ? `<img src="${b.cover}" style="width:100%; height:100%; object-fit:cover">` : b.title;
                document.getElementById('zone-wishlist').appendChild(div);
            }
        });
    }
};

// --- UI LOGIC ---
const ui = {
    openPanel: () => document.getElementById('side-panel').classList.add('open'),
    closePanel: () => document.getElementById('side-panel').classList.remove('open'),
    openModal: (b) => {
        focusId = b.id;
        document.getElementById('m-title').innerText = b.title;
        document.getElementById('m-author').innerText = b.author;
        document.getElementById('m-note').innerText = b.note || "Nessuna nota.";
        
        // --- FIX LINK ESTERNI ---
        const q = encodeURIComponent(b.title + " " + b.author);
        document.getElementById('lnk-amazon').href = `https://www.amazon.it/s?k=${q}&i=stripbooks`;
        // URL Kindle Corretto: usa i=digital-text per l'Italia
        document.getElementById('lnk-kindle').href = `https://www.amazon.it/s?k=${q}&i=digital-text`;
        document.getElementById('lnk-audible').href = `https://www.audible.it/search?keywords=${q}`;
        
        document.getElementById('modal-overlay').classList.add('active');
    },
    closeModal: () => document.getElementById('modal-overlay').classList.remove('active')
};

// --- RICERCA ROBUSTA (Timeout Lungo + Fallback) ---
const inp = document.getElementById('inpSearch');
const res = document.getElementById('search-results');
const stat = document.getElementById('search-status');
let timer;

inp.addEventListener('input', (e) => {
    const q = e.target.value;
    clearTimeout(timer);
    
    if(q.length < 3) { 
        res.classList.remove('active'); 
        stat.innerText = "In attesa...";
        return; 
    }

    stat.innerText = "Contatto Google Books...";
    
    timer = setTimeout(async () => {
        try {
            // Timeout di 10 secondi (molto più permissivo)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000);

            const req = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&langRestrict=it&maxResults=5`, { signal: controller.signal });
            const data = await req.json();
            clearTimeout(timeoutId);
            
            if(!data.items) throw new Error("Nessun risultato");

            stat.innerText = "Trovati " + data.items.length + " libri.";
            res.innerHTML = data.items.map(i => {
                const info = i.volumeInfo;
                const img = info.imageLinks?.smallThumbnail || '';
                // Escape dati
                return `<div class="res-item" onclick="selectBook('${info.title?.replace(/'/g,"")}', '${info.authors?.[0]?.replace(/'/g,"")}', '${img}', ${info.pageCount||200})">
                    <img src="${img}" class="res-img">
                    <div>
                        <div style="font-weight:bold; font-size:13px">${info.title}</div>
                        <div style="font-size:10px; color:#aaa">${info.authors?.[0]}</div>
                    </div>
                </div>`;
            }).join('');
            res.classList.add('active');
            
        } catch(e) {
            stat.innerText = "Errore Google: " + e.message + ". Provo fallback...";
            // Se fallisce Google, potremmo attivare OpenLibrary qui, ma intanto l'errore è visibile.
        }
    }, 800);
});

function selectBook(t, a, img, p) {
    document.getElementById('inpTitle').value = t;
    document.getElementById('inpAuthor').value = a;
    document.getElementById('inpPages').value = p;
    tempCover = img;
    res.classList.remove('active');
    document.getElementById('inpSearch').value = "";
    stat.innerText = "Libro caricato.";
}

// Start
app.init();
</script>
</body>
</html>
