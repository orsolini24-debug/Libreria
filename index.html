<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Libreria 2.0 - Immersive & Italian</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg: #050505;
      /* Glassmorphism avanzato */
      --glass: rgba(20, 25, 30, 0.65);
      --glass-border: rgba(255, 255, 255, 0.15);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      
      --accent: #60a5fa; /* Blu moderno */
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      
      --shadow-soft: 0 10px 30px rgba(0,0,0,0.5);
      --shadow-deep: 0 20px 60px rgba(0,0,0,0.8);
    }

    *{ box-sizing:border-box; }
    
    body{
      margin:0; font-family: 'Inter', sans-serif; 
      color:var(--text-main); background:var(--bg);
      height:100vh; overflow:hidden; /* App fullscreen */
    }

    /* BACKGROUND SFUMATO (Fallback se manca immagine) */
    body::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background: radial-gradient(circle at top center, #1e293b, #020617);
    }

    /* --- UI LAYOUT --- */
    .app-container{
      display: grid; grid-template-rows: auto 1fr;
      height: 100%; max-width: 1600px; margin: 0 auto;
      padding: 20px; gap: 20px;
    }

    /* HEADER TRASPARENTE */
    header{
      display:flex; justify-content:space-between; align-items:center;
      padding: 15px 25px;
      background: var(--glass); border: 1px solid var(--glass-border);
      border-radius: 16px; backdrop-filter: blur(12px);
      box-shadow: var(--shadow-soft);
    }
    
    .brand h1{ margin:0; font-size:20px; font-weight:800; letter-spacing:-0.5px; display:flex; align-items:center; gap:10px;}
    .brand span{ font-size:11px; font-weight:400; color:var(--text-muted); background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px;}

    .controls{ display:flex; gap:10px; }
    
    button{
      background: rgba(255,255,255,0.08); border: 1px solid var(--glass-border);
      color: var(--text-main); padding: 8px 16px; border-radius: 8px;
      cursor: pointer; font-weight: 600; font-size: 13px; transition: all .2s;
    }
    button:hover{ background: rgba(255,255,255,0.15); transform: translateY(-1px); }
    button.active{ background: var(--text-main); color: #000; }
    button.primary{ background: var(--accent); color: #000; border-color: var(--accent); }

    /* --- VIEWPORT --- */
    .viewport{ position:relative; width:100%; height:100%; overflow:hidden; border-radius:20px; border:1px solid var(--glass-border); }

    /* VISTA 1: LISTA DATA-ENTRY */
    .view-list{
      position:absolute; inset:0; background:rgba(10,10,12,0.9);
      padding:30px; overflow-y:auto; display:none; z-index:10;
    }
    .view-list.visible{ display:block; }

    /* Form Grid */
    .editor-grid{
      display:grid; grid-template-columns: 250px 1fr; gap:30px; max-width:1000px; margin:0 auto;
    }
    .cover-preview{
      width:100%; aspect-ratio:2/3; background:#1e293b; border-radius:12px;
      border:2px dashed var(--glass-border); display:flex; align-items:center; justify-content:center;
      overflow:hidden; position:relative;
    }
    .cover-preview img{ width:100%; height:100%; object-fit:cover; }
    
    .form-fields{ display:flex; flex-direction:column; gap:20px; }
    
    .input-group label{ display:block; font-size:12px; color:var(--text-muted); margin-bottom:6px; text-transform:uppercase; font-weight:600;}
    input, select, textarea{
      width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--glass-border);
      color:#fff; padding:12px; border-radius:8px; outline:none; font-family:inherit;
    }
    input:focus, textarea:focus{ border-color:var(--accent); background:rgba(0,0,0,0.5); }
    
    /* Search Dropdown */
    .search-box{ position:relative; }
    .dropdown{
      position:absolute; top:100%; left:0; right:0; background:#1e293b; 
      border:1px solid var(--glass-border); border-radius:8px; z-index:100;
      max-height:250px; overflow-y:auto; margin-top:5px; display:none;
      box-shadow: var(--shadow-deep);
    }
    .dd-item{ padding:12px; border-bottom:1px solid rgba(255,255,255,0.05); cursor:pointer; display:flex; gap:10px; align-items:center; }
    .dd-item:hover{ background:rgba(255,255,255,0.05); }
    
    /* VISTA 2: STANZA 3D */
    .view-room{
      position:absolute; inset:0; 
      perspective: 1500px; /* Prospettiva globale della scena */
      overflow:hidden;
      display:none;
    }
    .view-room.visible{ display:block; }

    .room-bg{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
      transform: scale(1.05); /* Zoom leggero per evitare bordi */
      filter: brightness(0.75) contrast(1.1); /* Atmosfera */
      z-index: 0;
    }

    /* ZONE LOGICHE (Contenitori Invisibili) */
    .zone{ position:absolute; z-index:10; }
    
    /* Debug Mode: aggiungi classe .debug al body per vedere i box */
    body.debug .zone{ border: 1px dashed red; background: rgba(255,0,0,0.1); }

    /* Tavolo: posizionato in basso a sinistra rispetto alla foto */
    .zone-table{
      bottom: 12%; left: 25%; width: 40%; height: 30%;
      display:flex; align-items:center; justify-content:center; gap: 40px;
      /* Il piano del tavolo Ã¨ inclinato nella foto, simuliamo col 3D */
      transform-style: preserve-3d;
      perspective: 800px;
    }

    /* Scaffali: Sfondo destra */
    .zone-shelf-1{ top: 16%; left: 51%; width: 28%; height: 11%; display:flex; align-items:flex-end; gap:2px; }
    .zone-shelf-2{ top: 32%; left: 51%; width: 28%; height: 11%; display:flex; align-items:flex-end; gap:2px; }
    
    /* Wishlist */
    .zone-wish{ bottom: 5%; right: 5%; width: 15%; height: 15%; display:flex; flex-wrap:wrap; gap:5px; transform:rotate(-5deg); opacity:0.8; }

    /* --- IL LIBRO 3D (CUBE ENGINE) --- */
    .book-3d{
      position: relative;
      width: 140px; aspect-ratio: 2/3;
      transform-style: preserve-3d;
      cursor: pointer;
      transition: transform 0.3s ease;
      /* Default state: Appoggiato sul tavolo */
      transform: rotateX(60deg) rotateZ(-15deg);
    }
    
    .book-3d:hover{
      /* Hover state: Si solleva e raddrizza leggermente */
      transform: rotateX(40deg) rotateZ(-5deg) translateZ(30px);
    }

    /* Facce del libro */
    .face{ position: absolute; inset:0; backface-visibility: hidden; }
    
    /* Copertina */
    .face-front{ 
      transform: translateZ(12px); /* Spessore metÃ  libro */
      background: #333; border-radius: 2px;
      box-shadow: inset 2px 0 5px rgba(255,255,255,0.2); /* Luce sul bordo */
    }
    .face-front img{ width:100%; height:100%; object-fit:cover; border-radius:2px; }

    /* Pagine laterali (Spessore) */
    .face-right{
      width: 24px; height: 100%; left: 100%; top:0;
      transform: rotateY(90deg) translateZ(-12px); /* Posiziona sul lato */
      background: linear-gradient(to right, #eee, #ddd 20%, #eee 40%, #ccc); /* Texture pagine */
    }
    .face-bottom{
      width: 100%; height: 24px; top: 100%; left:0;
      transform: rotateX(-90deg) translateZ(-12px);
      background: #ddd;
    }
    
    /* Dorso (Spine) - Non visibile quando piatto, ma serve per completezza */
    .face-spine{
      width: 24px; height: 100%; right: 100%; top:0;
      transform: rotateY(-90deg) translateZ(-12px);
      background: #222;
    }

    /* Ombra realistica sul tavolo (separata dal libro per prospettiva) */
    .book-shadow{
      position:absolute; width:100%; height:100%; top:15px; left:15px;
      background: rgba(0,0,0,0.6);
      filter: blur(10px);
      transform: translateZ(-30px); /* Sotto il libro */
      pointer-events: none;
    }

    /* --- LIBRI SU SCAFFALE (Solo Dorso 2D avanzato) --- */
    .spine-item{
      width: 20px; height: 90%; 
      background: linear-gradient(90deg, #333, #555 30%, #333);
      border-radius: 2px; cursor: pointer; position: relative;
      transition: transform 0.2s;
      box-shadow: 1px 0 3px rgba(0,0,0,0.5);
    }
    .spine-item:hover{ transform: scaleY(1.05) translateY(-2px); z-index:100; background:#666; }
    /* Tooltip titolo */
    .spine-item:hover::after{
      content: attr(data-title);
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,0.9); padding:5px 10px; border-radius:4px;
      white-space:nowrap; font-size:12px; pointer-events:none; z-index:200;
    }

    /* MODAL DETTAGLI */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,0.8); backdrop-filter:blur(5px);
      z-index:2000; display:none; align-items:center; justify-content:center;
    }
    .modal-backdrop.on{ display:flex; }
    
    .modal-card{
      background: #151920; border:1px solid var(--glass-border);
      width: 500px; padding: 0; border-radius: 16px; overflow:hidden;
      box-shadow: var(--shadow-deep);
    }
    .modal-header{
      padding:20px; background:rgba(255,255,255,0.03); border-bottom:1px solid var(--glass-border);
      display:flex; justify-content:space-between; align-items:center;
    }
    .modal-body{ padding:25px; display:grid; grid-template-columns: 120px 1fr; gap:20px; }
    .modal-footer{
      padding:20px; border-top:1px solid var(--glass-border); display:flex; gap:10px; justify-content:flex-end;
    }
    
    .rating-stars{ color: #fbbf24; font-size:18px; letter-spacing:2px; }
    .badge{ padding:4px 8px; border-radius:4px; font-size:11px; text-transform:uppercase; font-weight:700; border:1px solid rgba(255,255,255,0.2); }
    .badge.reading{ color: #fbbf24; border-color:#fbbf24; }
    .badge.read{ color: #4ade80; border-color:#4ade80; }
    
  </style>
</head>
<body>

<div class="app-container">
  
  <header>
    <div class="brand">
      <h1>La Mia Libreria <span>2.0</span></h1>
    </div>
    <div class="controls">
      <button id="nav-list" onclick="setView('list')">Gestione Dati</button>
      <button id="nav-room" onclick="setView('room')" class="primary">Stanza Immersiva</button>
      <button onclick="exportData()" title="Backup">ðŸ’¾</button>
    </div>
  </header>

  <div class="viewport">
    
    <div id="view-list" class="view-list">
      <div class="editor-grid">
        
        <div>
          <div class="cover-preview">
            <img id="preview-img" src="" style="display:none">
            <span id="preview-text" style="color:var(--text-muted)">Nessuna<br>Copertina</span>
          </div>
          <div style="text-align:center; margin-top:10px;">
            <div id="star-input" style="cursor:pointer; color:#555; font-size:24px;">â˜…â˜…â˜…â˜…â˜…</div>
            <span style="font-size:12px; color:var(--text-muted)">Voto</span>
          </div>
        </div>

        <div class="form-fields">
          <div class="search-box">
            <div class="input-group">
              <label>Cerca Libro (Edizioni Italiane)</label>
              <input id="inpSearch" placeholder="Es. Calvino, Eco, Baricco..." autocomplete="off">
            </div>
            <div class="dropdown" id="ddResults"></div>
          </div>

          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div class="input-group">
              <label>Autore</label>
              <input id="inpAuthor" readonly style="opacity:0.7">
            </div>
            <div class="input-group">
              <label>Stato</label>
              <select id="inpStatus">
                <option value="reading">ðŸ“– In Lettura (Tavolo)</option>
                <option value="to_read">ðŸ“š Da Leggere (Scaffale Basso)</option>
                <option value="read">âœ… Letto (Scaffale Alto)</option>
                <option value="wishlist">ðŸ’¸ Wishlist (Angolo)</option>
              </select>
            </div>
          </div>

          <div class="input-group">
            <label>La tua Recensione / Note</label>
            <textarea id="inpComment" rows="4" placeholder="Cosa ne pensi?"></textarea>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
             <span id="msg-save" style="font-size:12px; color:#4ade80; opacity:0; transition:opacity .3s">Salvato!</span>
             <div>
               <button onclick="clearForm()">Pulisci</button>
               <button class="primary" onclick="saveBook()">Salva Libro</button>
             </div>
          </div>

          <div style="margin-top:20px; border-top:1px solid var(--glass-border); padding-top:20px;">
            <label>Libri in memoria:</label>
            <div id="mini-list" style="display:flex; gap:10px; overflow-x:auto; padding:10px 0;"></div>
          </div>

        </div>
      </div>
    </div>

    <div id="view-room" class="view-room visible">
      <img src="./assets/room.jpg" class="room-bg" onerror="this.style.display='none'">
      
      <div class="zone zone-shelf-1" id="shelf-high"></div>
      <div class="zone zone-shelf-2" id="shelf-low"></div>
      <div class="zone zone-table" id="table-surface"></div>
      <div class="zone zone-wish" id="wish-corner"></div>
    </div>

  </div>

</div>

<div class="modal-backdrop" id="modal-focus" onclick="if(event.target===this) closeModal()">
  <div class="modal-card">
    <div class="modal-header">
      <h3 style="margin:0">Dettagli Libro</h3>
      <button onclick="closeModal()" style="padding:4px 10px;">âœ•</button>
    </div>
    <div class="modal-body">
      <img id="m-cover" style="width:100%; border-radius:8px; object-fit:cover;">
      <div>
        <h2 id="m-title" style="margin:0 0 5px 0; font-size:20px;">Titolo</h2>
        <p id="m-author" style="color:var(--text-muted); margin:0 0 10px 0;">Autore</p>
        <span id="m-badge" class="badge">Stato</span>
        <div id="m-stars" class="rating-stars" style="margin:10px 0;"></div>
        <p id="m-comment" style="font-size:14px; line-height:1.5; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">...</p>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="deleteBook()" style="color:#fb7185; border-color:rgba(251,113,133,0.3);">Elimina</button>
      <button class="primary" onclick="closeModal()">Chiudi</button>
    </div>
  </div>
</div>

<script>
// --- CORE DATA ---
const LS_KEY = "lib_v2_ultimate";
let books = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
let tempBook = null; 
let currentRating = 0;
let focusId = null;

// --- INIT ---
function init(){
    setView('room'); // Partiamo dalla stanza per effetto wow
    renderMiniList();
    renderRoom();
    setupStars();
}

// --- NAVIGATION ---
function setView(mode){
    document.querySelectorAll('[id^="view-"]').forEach(el => el.classList.remove('visible'));
    document.getElementById('view-'+mode).classList.add('visible');
    
    document.getElementById('nav-list').classList.toggle('active', mode==='list');
    document.getElementById('nav-room').classList.toggle('active', mode==='room');
    
    if(mode === 'room') renderRoom();
    if(mode === 'list') renderMiniList();
}

// --- SEARCH ENGINE (ITALIANO FORZATO) ---
const inpSearch = document.getElementById('inpSearch');
const dd = document.getElementById('ddResults');
let timer;

inpSearch.addEventListener('input', (e) => {
    const q = e.target.value.trim();
    if(q.length < 3) { dd.style.display='none'; return; }
    
    clearTimeout(timer);
    timer = setTimeout(async () => {
        // TRUCCO: Aggiungo &language=ita per filtrare i risultati
        const url = `https://openlibrary.org/search.json?q=${encodeURIComponent(q)}&language=ita&limit=6`;
        try{
            const res = await fetch(url);
            const data = await res.json();
            
            dd.innerHTML = data.docs.map(d => {
                const img = d.cover_i ? `https://covers.openlibrary.org/b/id/${d.cover_i}-S.jpg` : '';
                // Fallback titolo/autore
                const t = (d.title || "Senza titolo").replace(/'/g, "&apos;");
                const a = (d.author_name?.[0] || "Sconosciuto").replace(/'/g, "&apos;");
                
                return `
                <div class="dd-item" onclick="selectBook('${t}', '${a}', '${img}')">
                    <div style="width:30px; height:45px; background:#333; flex-shrink:0;">
                        ${img ? `<img src="${img}" style="width:100%; height:100%; object-fit:cover;">` : ''}
                    </div>
                    <div>
                        <div style="font-weight:600; color:#fff;">${t}</div>
                        <div style="font-size:12px; color:#999;">${a}</div>
                    </div>
                </div>`;
            }).join('');
            dd.style.display = 'block';
        } catch(e){ console.error(e); }
    }, 400);
});

function selectBook(title, author, cover){
    document.getElementById('inpSearch').value = title;
    document.getElementById('inpAuthor').value = author;
    
    // Aggiorna preview
    const prevImg = document.getElementById('preview-img');
    const prevTxt = document.getElementById('preview-text');
    
    if(cover){
        prevImg.src = cover.replace('-S.jpg', '-L.jpg'); // Prova alta qualitÃ 
        prevImg.style.display = 'block';
        prevTxt.style.display = 'none';
    } else {
        prevImg.style.display = 'none';
        prevTxt.style.display = 'block';
    }
    
    tempBook = { title, author, cover: cover ? cover.replace('-S.jpg', '-M.jpg') : '' };
    dd.style.display = 'none';
}

// --- RATING SYSTEM ---
function setupStars(){
    const starContainer = document.getElementById('star-input');
    starContainer.innerHTML = '';
    for(let i=1; i<=5; i++){
        const s = document.createElement('span');
        s.innerText = 'â˜…';
        s.onclick = () => { currentRating = i; updateStarsUI(i); };
        starContainer.appendChild(s);
    }
    updateStarsUI(0);
}

function updateStarsUI(n){
    const stars = document.getElementById('star-input').children;
    for(let i=0; i<5; i++){
        stars[i].style.color = i < n ? '#fbbf24' : '#444';
    }
}

// --- SAVING ---
function saveBook(){
    if(!tempBook && !document.getElementById('inpSearch').value) return alert("Cerca un libro prima!");
    
    const finalBook = {
        id: crypto.randomUUID(),
        title: document.getElementById('inpSearch').value,
        author: document.getElementById('inpAuthor').value || "Sconosciuto",
        cover: tempBook?.cover || "",
        status: document.getElementById('inpStatus').value,
        comment: document.getElementById('inpComment').value,
        rating: currentRating,
        timestamp: Date.now()
    };
    
    books.push(finalBook);
    localStorage.setItem(LS_KEY, JSON.stringify(books));
    
    // Feedback
    const msg = document.getElementById('msg-save');
    msg.style.opacity = 1;
    setTimeout(() => msg.style.opacity = 0, 2000);
    
    renderMiniList();
    clearForm();
}

function clearForm(){
    document.getElementById('inpSearch').value = "";
    document.getElementById('inpAuthor').value = "";
    document.getElementById('inpComment').value = "";
    document.getElementById('preview-img').style.display = 'none';
    document.getElementById('preview-text').style.display = 'block';
    tempBook = null;
    currentRating = 0;
    updateStarsUI(0);
}

// --- RENDER ROOM (3D ENGINE) ---
function renderRoom(){
    const zones = {
        table: document.getElementById('table-surface'),
        shelf1: document.getElementById('shelf-high'),
        shelf2: document.getElementById('shelf-low'),
        wish: document.getElementById('wish-corner')
    };
    
    // Pulisci
    Object.values(zones).forEach(z => z.innerHTML = '');
    
    books.forEach(b => {
        // LOGICA TAVOLO (3D REALE)
        if(b.status === 'reading'){
            const cube = document.createElement('div');
            cube.className = 'book-3d';
            cube.onclick = () => openModal(b.id);
            cube.innerHTML = `
                <div class="book-shadow"></div>
                <div class="face face-bottom"></div>
                <div class="face face-right"></div>
                <div class="face face-spine"></div>
                <div class="face face-front">
                    ${b.cover ? `<img src="${b.cover}">` : `<div style="padding:10px; font-size:10px;">${b.title}</div>`}
                </div>
            `;
            zones.table.appendChild(cube);
        }
        // LOGICA SCAFFALI (DORSI 2D)
        else if(b.status === 'read' || b.status === 'to_read'){
            const spine = document.createElement('div');
            spine.className = 'spine-item';
            spine.setAttribute('data-title', b.title);
            // Genera colore pseudo-randomico in base al titolo per variare
            const hue = (b.title.length * 50) % 360;
            spine.style.background = `linear-gradient(90deg, hsl(${hue}, 30%, 20%), hsl(${hue}, 30%, 35%) 40%, hsl(${hue}, 30%, 20%))`;
            spine.style.height = (80 + (b.title.length % 20)) + '%';
            spine.onclick = () => openModal(b.id);
            
            if(b.status === 'read') zones.shelf1.appendChild(spine);
            else zones.shelf2.appendChild(spine);
        }
        // LOGICA WISHLIST
        else {
            const item = document.createElement('img');
            item.src = b.cover || '';
            item.style.width = '30px'; item.style.height='45px'; item.style.objectFit='cover';
            item.style.opacity = 0.7; item.style.cursor='pointer';
            item.onclick = () => openModal(b.id);
            zones.wish.appendChild(item);
        }
    });
}

// --- RENDER MINI LIST ---
function renderMiniList(){
    const list = document.getElementById('mini-list');
    list.innerHTML = books.map(b => `
        <div style="flex:0 0 60px; cursor:pointer;" onclick="openModal('${b.id}')">
            <img src="${b.cover}" style="width:60px; height:90px; object-fit:cover; border-radius:4px; background:#333;">
            <div style="font-size:10px; overflow:hidden; white-space:nowrap; margin-top:4px;">${b.title}</div>
        </div>
    `).join('');
}

// --- MODAL & ACTIONS ---
function openModal(id){
    focusId = id;
    const b = books.find(x => x.id === id);
    if(!b) return;
    
    document.getElementById('m-title').innerText = b.title;
    document.getElementById('m-author').innerText = b.author;
    document.getElementById('m-cover').src = b.cover;
    document.getElementById('m-badge').innerText = b.status.toUpperCase().replace('_', ' ');
    document.getElementById('m-badge').className = 'badge ' + b.status;
    document.getElementById('m-comment').innerText = b.comment || "Nessuna recensione inserita.";
    document.getElementById('m-stars').innerHTML = 'â˜…'.repeat(b.rating) + '<span style="color:#444">' + 'â˜…'.repeat(5-b.rating) + '</span>';
    
    document.getElementById('modal-focus').classList.add('on');
}

function closeModal(){
    document.getElementById('modal-focus').classList.remove('on');
}

function deleteBook(){
    if(!confirm("Sicuro?")) return;
    books = books.filter(b => b.id !== focusId);
    localStorage.setItem(LS_KEY, JSON.stringify(books));
    closeModal();
    if(document.getElementById('view-room').classList.contains('visible')) renderRoom();
    else renderMiniList();
}

function exportData(){
    const data = JSON.stringify(books, null, 2);
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'libreria_backup.json';
    a.click();
}

// Start
init();

</script>
</body>
</html>
