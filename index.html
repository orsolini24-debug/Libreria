<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Libreria</title>
  <style>
    :root{
      --bg:#07090c; --card:rgba(16,20,27,.78); --text:#e9eef5; --muted:#9aa6b2; --border:#223041;
      --accent:#7aa2f7; --danger:#ff6b6b;
      --glass:rgba(16,20,27,.62);
      --shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{max-width:1200px;margin:0 auto;padding:18px 16px 10px}
    h1{margin:0 0 6px;font-size:20px;font-weight:750}
    .sub{color:var(--muted);font-size:13px}
    main{max-width:1200px;margin:0 auto;padding:14px 16px 22px;display:grid;gap:14px}

    .panel{
      background:var(--glass);
      border:1px solid rgba(34,48,65,.85);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input,select,button{font:inherit}
    input,select{
      background:rgba(12,16,22,.85);
      color:var(--text);
      border:1px solid rgba(34,48,65,.95);
      border-radius:12px;
      padding:10px 10px;
      min-width:180px;
      outline:none;
    }
    input::placeholder{color:#66727e}
    button{
      background:var(--accent);color:#0b0d10;border:none;border-radius:12px;
      padding:10px 12px;cursor:pointer;font-weight:750;
    }
    button.secondary{background:transparent;color:var(--text);border:1px solid rgba(34,48,65,.95)}
    button.danger{background:transparent;color:var(--danger);border:1px solid rgba(255,107,107,.35)}
    button:disabled{opacity:.55;cursor:not-allowed}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between;margin-top:10px}
    .counts{color:var(--muted);font-size:12px}

    .viewbar{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .seg{display:flex;gap:8px;align-items:center}
    .seg button{padding:8px 12px;font-size:12px;border-radius:999px}
    .seg button.active{background:var(--accent);color:#0b0d10;border:none}
    .seg button.inactive{background:transparent;color:var(--text);border:1px solid rgba(34,48,65,.95)}

    .hidden{display:none!important}

    /* LISTA */
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    @media (max-width: 980px){.grid3{grid-template-columns:1fr}}
    h2{margin:0 0 10px;font-size:15px;font-weight:750;color:#d8e1ee}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      border:1px solid rgba(34,48,65,.85);
      border-radius:14px;
      padding:10px;
      background:rgba(12,16,22,.85);
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .meta{display:flex;flex-direction:column;gap:3px;min-width:0}
    .title{font-weight:800;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:520px}
    .small{color:var(--muted);font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .chip{font-size:11px;color:#cfe1ff;border:1px solid rgba(122,162,247,.35);padding:2px 8px;border-radius:999px}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .actions button{padding:7px 10px;font-size:12px}

    /* ROOM */
    .roomPanel{padding:0; overflow:hidden}
    .room{
      position:relative;
      width:100%;
      height:min(72vh, 760px);
      min-height:520px;
      border-radius:16px;
      overflow:hidden;
      background:
        linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.60)),
        url("assets/room.jpg");
      background-size:cover;
      background-position:center;
      box-shadow: var(--shadow);
    }
    .room::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(520px 340px at 72% 58%, rgba(255,150,60,.20), transparent 65%),
        radial-gradient(340px 260px at 74% 62%, rgba(255,80,40,.12), transparent 62%),
        radial-gradient(520px 420px at 20% 20%, rgba(122,162,247,.10), transparent 55%);
      pointer-events:none;
      mix-blend-mode: screen;
      opacity:.9;
    }

    .zone{
      position:absolute;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(16,20,27,.30), rgba(16,20,27,.52));
      backdrop-filter: blur(4px);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .zoneHeader{
      position:absolute; left:12px; top:10px;
      display:flex; align-items:center; gap:10px;
      z-index:3;
    }
    .zoneTitle{font-size:13px;font-weight:800;text-shadow:0 2px 10px rgba(0,0,0,.6)}
    .badge{font-size:11px;color:#cfe1ff;border:1px solid rgba(122,162,247,.35);padding:2px 8px;border-radius:999px;background:rgba(0,0,0,.18)}
    .zoneBody{
      position:absolute; inset:0;
      padding:42px 12px 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-content:flex-start;
      z-index:2;
    }

    .zone.read { left:5%; top:14%; width:44%; height:46%; }
    .zone.reading { left:54%; top:22%; width:41%; height:40%; }
    .zone.toread { left:10%; bottom:8%; width:80%; height:26%; }

    @media (max-width: 980px){
      .room{height:auto; min-height:820px}
      .zone.read{left:6%;top:10%;width:88%;height:30%}
      .zone.reading{left:6%;top:43%;width:88%;height:26%}
      .zone.toread{left:6%;bottom:6%;width:88%;height:22%}
    }

    .bookBtn{
      appearance:none; border:none; background:none; padding:0; margin:0;
      cursor:pointer;
      position:relative;
    }
    .bookBtn:focus-visible{
      outline:none;
      box-shadow: 0 0 0 3px rgba(122,162,247,.35);
      border-radius:12px;
    }

    .spine{
      width:42px;
      height:160px;
      border-radius:10px;
      box-shadow: 0 18px 32px rgba(0,0,0,.35);
      border:1px solid rgba(0,0,0,.35);
      overflow:hidden;
      transform: perspective(800px) rotateY(-12deg);
      background-size:cover;
      background-position:center;
    }
    .spine::before{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,.18), transparent 28%, rgba(0,0,0,.25));
      pointer-events:none;
    }
    .spineTxt{
      position:absolute; left:7px; right:7px; bottom:10px;
      font-size:10px; font-weight:900; color:rgba(15,18,22,.92);
      writing-mode: vertical-rl; transform: rotate(180deg);
      text-shadow: 0 1px 0 rgba(255,255,255,.12);
      max-height:132px;
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }
    .spineSmall{
      position:absolute; left:7px; right:7px; top:8px;
      font-size:9px; color:rgba(15,18,22,.70);
      writing-mode: vertical-rl; transform: rotate(180deg);
      max-height:90px;
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }

    .miniSpine{
      width:36px; height:86px;
      border-radius:10px;
      box-shadow: 0 16px 28px rgba(0,0,0,.35);
      border:1px solid rgba(0,0,0,.35);
      overflow:hidden;
      transform: perspective(700px) rotateY(-10deg);
      background-size:cover;
      background-position:center;
    }
    .miniSpine::before{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(255,255,255,.16), transparent 30%, rgba(0,0,0,.25));
      pointer-events:none;
    }
    .miniTxt{
      position:absolute; left:6px; right:6px; bottom:7px;
      font-size:9px; font-weight:900; color:rgba(15,18,22,.92);
      writing-mode: vertical-rl; transform: rotate(180deg);
      max-height:68px;
      overflow:hidden; white-space:nowrap; text-overflow:ellipsis;
    }

    .hbook{
      width:min(520px, 100%);
      height:44px;
      border-radius:14px;
      box-shadow: 0 18px 32px rgba(0,0,0,.35);
      border:1px solid rgba(0,0,0,.35);
      overflow:hidden;
      display:flex; align-items:center; gap:10px;
      padding:0 12px;
      background-size:cover;
      background-position:center;
      transform: perspective(900px) rotateX(6deg);
      position:relative;
    }
    .hbook::before{
      content:"";
      position:absolute; inset:0;
      background:linear-gradient(180deg, rgba(255,255,255,.14), transparent 45%, rgba(0,0,0,.25));
      pointer-events:none;
    }
    .hbookInfo{display:flex;flex-direction:column;min-width:0;position:relative;z-index:1}
    .hbookTitle{font-weight:900;font-size:12px;color:rgba(15,18,22,.92);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .hbookAuthor{font-size:11px;color:rgba(15,18,22,.72);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    .tip{
      position:absolute;
      left:50%; top:-8px;
      transform: translate(-50%, -100%);
      background: rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.10);
      color: #e9eef5;
      padding:6px 8px;
      border-radius:10px;
      font-size:12px;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transition: opacity .12s ease;
      z-index:10;
    }
    .bookBtn:hover .tip{opacity:1}

    /* MODAL */
    .modal.hidden{display:none!important}
    .modal{position:fixed;inset:0;z-index:9999}
    .modalBackdrop{position:absolute;inset:0;background:rgba(0,0,0,.60);backdrop-filter: blur(5px)}
    .modalCard{
      position:relative;
      max-width:820px;
      margin:5vh auto;
      background:rgba(16,20,27,.94);
      border:1px solid rgba(34,48,65,.90);
      border-radius:18px;
      box-shadow:0 30px 90px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(34,48,65,.55);
    }
    .modalTitle{font-size:17px;font-weight:900}
    .modalSub{font-size:12px;color:var(--muted);margin-top:2px}
    .modalClose{background:transparent;border:1px solid rgba(34,48,65,.95);color:var(--text);border-radius:12px;padding:8px 10px;cursor:pointer}
    .modalBody{padding:12px 14px 14px;display:grid;gap:12px}
    .modalGrid{display:grid;grid-template-columns: 160px 1fr; gap:14px}
    @media (max-width: 740px){ .modalGrid{grid-template-columns:1fr} }
    .cover{
      width:160px;height:240px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 40px rgba(0,0,0,.45);
      background-size:cover;background-position:center;
      overflow:hidden;
    }
    .kv{display:grid;gap:10px}
    .kvRow{display:grid;grid-template-columns:120px 1fr;gap:10px;align-items:baseline}
    .k{font-size:12px;color:var(--muted)}
    .v{font-size:13px;color:var(--text)}
    .modalActions{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .linkBtn{background:transparent;color:var(--text);border:1px solid rgba(34,48,65,.95);border-radius:12px;padding:9px 11px;cursor:pointer;font-weight:750}

    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .ok{color:#9be7b3}
    .warn{color:#ffd06a}

    /* AUTOCOMPLETE DROPDOWN */
    .fieldWrap{position:relative; min-width:240px;}
    .dropdown{
      position:absolute;
      top:calc(100% + 6px);
      left:0;
      width:min(560px, 90vw);
      background:rgba(10,12,16,.96);
      border:1px solid rgba(34,48,65,.95);
      border-radius:14px;
      box-shadow:0 22px 60px rgba(0,0,0,.55);
      overflow:hidden;
      z-index:2000;
    }
    .dropdown.hidden{display:none!important}
    .ddHeader{
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-bottom:1px solid rgba(34,48,65,.55);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .ddList{
      max-height:320px;
      overflow:auto;
    }
    .ddItem{
      display:flex;
      gap:10px;
      padding:10px 12px;
      cursor:pointer;
      align-items:center;
      border-bottom:1px solid rgba(34,48,65,.35);
    }
    .ddItem:hover{background:rgba(122,162,247,.10)}
    .ddCover{
      width:34px;
      height:48px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.10);
      background-size:cover;
      background-position:center;
      flex:0 0 auto;
    }
    .ddMain{min-width:0}
    .ddTitle{font-size:12px;font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .ddMeta{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .kbd{
      font-size:11px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(34,48,65,.95);
      color:var(--muted);
    }
  </style>
</head>

<body>
  <header>
    <h1>Libreria</h1>
    <div class="sub">Vista Lista o Stanza. Dati salvati localmente nel browser. Ricerca titolo/autore: Open Library.</div>
  </header>

  <main>
    <section class="panel">
      <div class="viewbar">
        <div>
          <div class="counts" id="counts"></div>
          <div class="hint" id="lookupHint"></div>
        </div>
        <div class="seg">
          <button id="btnList" class="active" type="button">Lista</button>
          <button id="btnRoom" class="inactive" type="button">Stanza</button>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="fieldWrap">
          <label for="title">Titolo *</label>
          <input id="title" placeholder="es. Demian" autocomplete="off" />
          <div id="suggestBox" class="dropdown hidden">
            <div class="ddHeader">
              <div id="ddStatus">Suggerimenti</div>
              <div class="kbd">↑↓ invio • esc</div>
            </div>
            <div id="ddList" class="ddList"></div>
          </div>
        </div>

        <div style="min-width:240px;">
          <label for="author">Autore</label>
          <input id="author" placeholder="es. Hermann Hesse" />
        </div>

        <div>
          <label for="status">Stato *</label>
          <select id="status">
            <option value="to-read">Da leggere</option>
            <option value="reading">In lettura</option>
            <option value="read">Letto</option>
          </select>
        </div>

        <div>
          <label for="rating">Valutazione (0–5)</label>
          <select id="rating">
            <option value="">—</option>
            <option value="1">1</option><option value="2">2</option><option value="3">3</option>
            <option value="4">4</option><option value="5">5</option>
          </select>
        </div>

        <div style="min-width:260px;">
          <label for="tags">Tag (virgole)</label>
          <input id="tags" placeholder="filosofia, romanzo, classici" />
        </div>

        <div>
          <button id="saveBtn" type="button">Salva</button>
        </div>
        <div>
          <button id="cancelEditBtn" class="secondary hidden" type="button">Annulla</button>
        </div>
      </div>

      <div class="toolbar">
        <div class="row" style="align-items:center;">
          <div>
            <label for="search">Cerca</label>
            <input id="search" placeholder="titolo, autore, tag..." />
          </div>
          <div>
            <label for="sort">Ordina</label>
            <select id="sort">
              <option value="updated_desc">Ultima modifica (↓)</option>
              <option value="updated_asc">Ultima modifica (↑)</option>
              <option value="title_asc">Titolo (A→Z)</option>
              <option value="title_desc">Titolo (Z→A)</option>
              <option value="author_asc">Autore (A→Z)</option>
              <option value="author_desc">Autore (Z→A)</option>
            </select>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-left:6px;">
            <button id="toggleLookup" class="secondary" type="button">Lookup ON</button>
          </div>
        </div>

        <div class="row" style="align-items:center;">
          <button id="exportBtn" class="secondary" type="button">Esporta JSON</button>
          <button id="importBtn" class="secondary" type="button">Importa JSON</button>
          <button id="wipeBtn" class="danger" type="button">Svuota</button>
        </div>
      </div>

      <div id="importArea" class="hidden" style="margin-top:10px;">
        <div class="hint">Incolla il JSON esportato e conferma.</div>
        <textarea id="importText" style="background:rgba(12,16,22,.85);color:var(--text);border:1px solid rgba(34,48,65,.95);border-radius:12px;padding:10px;width:100%;min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;"></textarea>
        <div class="row" style="margin-top:8px;">
          <button id="confirmImportBtn" type="button">Conferma import</button>
          <button id="cancelImportBtn" class="secondary" type="button">Annulla</button>
        </div>
      </div>

      <div id="exportArea" class="hidden" style="margin-top:10px;">
        <div class="hint">Copia e salva questo JSON (backup).</div>
        <textarea id="exportText" readonly style="background:rgba(12,16,22,.85);color:var(--text);border:1px solid rgba(34,48,65,.95);border-radius:12px;padding:10px;width:100%;min-height:120px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;"></textarea>
        <div class="row" style="margin-top:8px;">
          <button id="closeExportBtn" class="secondary" type="button">Chiudi</button>
        </div>
      </div>
    </section>

    <section id="viewList" class="grid3">
      <section class="panel">
        <h2>Da leggere</h2>
        <div class="list" id="list-to-read"></div>
      </section>
      <section class="panel">
        <h2>In lettura</h2>
        <div class="list" id="list-reading"></div>
      </section>
      <section class="panel">
        <h2>Letti</h2>
        <div class="list" id="list-read"></div>
      </section>
    </section>

    <section id="viewRoom" class="panel roomPanel hidden">
      <div class="room" id="room">
        <div class="zone read">
          <div class="zoneHeader">
            <div class="zoneTitle">Letti</div>
            <div class="badge">Scaffale</div>
          </div>
          <div class="zoneBody" id="room-read"></div>
        </div>

        <div class="zone reading">
          <div class="zoneHeader">
            <div class="zoneTitle">In lettura</div>
            <div class="badge">Vicino al fuoco</div>
          </div>
          <div class="zoneBody" id="room-reading"></div>
        </div>

        <div class="zone toread">
          <div class="zoneHeader">
            <div class="zoneTitle">Da leggere</div>
            <div class="badge">Stack orizzontale</div>
          </div>
          <div class="zoneBody" id="room-toread"></div>
        </div>
      </div>
    </section>
  </main>

  <div id="bookModal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modalBackdrop" data-close="1"></div>
    <div class="modalCard">
      <div class="modalHeader">
        <div>
          <div id="modalTitle" class="modalTitle"></div>
          <div id="modalSub" class="modalSub"></div>
        </div>
        <button id="modalClose" class="modalClose" type="button" aria-label="Chiudi">✕</button>
      </div>
      <div class="modalBody">
        <div class="modalGrid">
          <div id="modalCover" class="cover"></div>
          <div class="kv">
            <div class="kvRow"><div class="k">Stato</div><div class="v" id="modalStatus"></div></div>
            <div class="kvRow"><div class="k">Valutazione</div><div class="v" id="modalRating"></div></div>
            <div class="kvRow"><div class="k">Tag</div><div class="v" id="modalTags"></div></div>
            <div class="kvRow"><div class="k">Aggiornato</div><div class="v" id="modalUpdated"></div></div>

            <div class="modalActions">
              <button id="modalEdit" class="secondary" type="button">Modifica</button>
              <button id="modalCycle" class="secondary" type="button">Cambia stato</button>
              <button id="modalDelete" class="danger" type="button">Elimina</button>
              <button id="modalOpenLibrary" class="linkBtn" type="button">Open Library</button>
              <button id="modalAudible" class="linkBtn" type="button">Audible</button>
              <button id="modalKindle" class="linkBtn" type="button">Kindle</button>
            </div>

            <div class="hint">Nota: i link Audible/Kindle sono ricerche. In futuro possiamo salvare link/PDF specifici per libro.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "libreria_personale_v3";
    const el = (id) => document.getElementById(id);

    const state = {
      books: [],
      editingId: null,
      search: "",
      sort: "updated_desc",
      view: "list",
      lookupEnabled: true,

      // autocomplete
      suggestOpen: false,
      suggestItems: [],
      suggestIndex: -1,
      suggestReqId: 0,
      selectedSuggestion: null
    };

    function nowIso(){ return new Date().toISOString(); }
    function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
    function normalize(s){ return (s||"").toString().trim().toLowerCase(); }

    function statusLabel(s){
      if(s==="read") return "Letto";
      if(s==="reading") return "In lettura";
      return "Da leggere";
    }

    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        state.books = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(state.books)) state.books = [];
      }catch{ state.books = []; }

      const v = localStorage.getItem(STORAGE_KEY + "_view");
      if(v === "room" || v === "list") state.view = v;

      const lk = localStorage.getItem(STORAGE_KEY + "_lookup");
      if(lk === "0") state.lookupEnabled = false;
    }

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state.books)); }
    function saveView(){ localStorage.setItem(STORAGE_KEY + "_view", state.view); }
    function saveLookup(){ localStorage.setItem(STORAGE_KEY + "_lookup", state.lookupEnabled ? "1" : "0"); }

    function parseTags(raw){
      return (raw || "").split(",").map(s => s.trim()).filter(Boolean);
    }

    function setHint(msg, kind){
      const h = el("lookupHint");
      h.textContent = msg || "";
      h.className = "hint" + (kind ? (" " + kind) : "");
    }

    function debounce(fn, ms){
      let t = null;
      return (...args) => {
        if(t) clearTimeout(t);
        t = setTimeout(() => fn(...args), ms);
      };
    }

    function getFilteredSorted(){
      const q = normalize(state.search);
      let items = [...state.books];

      if(q){
        items = items.filter(b => {
          const hay = [b.title, b.author, (b.tags||[]).join(" ")].map(normalize).join(" ");
          return hay.includes(q);
        });
      }

      const sort = state.sort;
      const cmpStr = (a,b) => (a||"").localeCompare(b||"", "it", { sensitivity:"base" });

      items.sort((a,b) => {
        if(sort === "updated_desc") return (b.updatedAt||"").localeCompare(a.updatedAt||"");
        if(sort === "updated_asc")  return (a.updatedAt||"").localeCompare(b.updatedAt||"");
        if(sort === "title_asc")    return cmpStr(a.title, b.title);
        if(sort === "title_desc")   return cmpStr(b.title, a.title);
        if(sort === "author_asc")   return cmpStr(a.author, b.author);
        if(sort === "author_desc")  return cmpStr(b.author, a.author);
        return 0;
      });

      return items;
    }

    function upsertBook(book){
      const idx = state.books.findIndex(b => b.id === book.id);
      if(idx >= 0) state.books[idx] = book;
      else state.books.push(book);
      save();
      render();
    }

    function removeBook(id){
      state.books = state.books.filter(b => b.id !== id);
      save();
      render();
    }

    function setEditing(book){
      state.editingId = book.id;
      el("title").value = book.title || "";
      el("author").value = book.author || "";
      el("status").value = book.status || "to-read";
      el("rating").value = book.rating ?? "";
      el("tags").value = (book.tags || []).join(", ");
      el("saveBtn").textContent = "Aggiorna";
      el("cancelEditBtn").classList.remove("hidden");

      // in editing, non forzo autocomplete
      closeSuggest();
      state.selectedSuggestion = null;
    }

    function clearForm(){
      state.editingId = null;
      el("title").value = "";
      el("author").value = "";
      el("status").value = "to-read";
      el("rating").value = "";
      el("tags").value = "";
      el("saveBtn").textContent = "Salva";
      el("cancelEditBtn").classList.add("hidden");
      setHint(state.lookupEnabled ? "Lookup attivo: digita un titolo e scegli dalla tendina." : "Lookup disattivato.", state.lookupEnabled ? "ok" : "warn");

      closeSuggest();
      state.selectedSuggestion = null;
    }

    // ----------------- AUTOCOMPLETE: Open Library -----------------
    function coverFromId(coverId){
      return coverId ? ("https://covers.openlibrary.org/b/id/" + coverId + "-M.jpg") : "";
    }

    function openLibraryWorkUrl(keyOrWork){
      if(!keyOrWork) return "";
      // spesso è "/works/OL...W" o "/books/..."
      if(keyOrWork.startsWith("/")) return "https://openlibrary.org" + keyOrWork;
      return "https://openlibrary.org/works/" + keyOrWork;
    }

    function showSuggest(items, infoText){
      state.suggestItems = items;
      state.suggestIndex = items.length ? 0 : -1;
      state.suggestOpen = true;

      el("ddStatus").textContent = infoText || (items.length ? "Seleziona un risultato" : "Nessun risultato");
      const list = el("ddList");
      list.innerHTML = "";

      if(!items.length){
        const div = document.createElement("div");
        div.className = "ddItem";
        div.innerHTML = `<div class="ddMain"><div class="ddTitle">Nessun match</div><div class="ddMeta">Continua a scrivere…</div></div>`;
        list.appendChild(div);
      } else {
        items.forEach((it, idx) => {
          const row = document.createElement("div");
          row.className = "ddItem";
          row.dataset.idx = String(idx);

          const c = document.createElement("div");
          c.className = "ddCover";
          c.style.backgroundImage = it.coverUrl ? `url("${it.coverUrl}")` : "none";
          c.style.backgroundColor = it.coverUrl ? "transparent" : "rgba(255,255,255,.06)";

          const main = document.createElement("div");
          main.className = "ddMain";

          const t = document.createElement("div");
          t.className = "ddTitle";
          t.textContent = it.title || "(senza titolo)";

          const m = document.createElement("div");
          m.className = "ddMeta";
          const parts = [];
          if(it.author) parts.push(it.author);
          if(it.firstPublishYear) parts.push(String(it.firstPublishYear));
          if(it.editionCount) parts.push(it.editionCount + " edizioni");
          m.textContent = parts.join(" • ") || "—";

          main.appendChild(t);
          main.appendChild(m);

          row.appendChild(c);
          row.appendChild(main);

          row.addEventListener("mousedown", (e) => {
            // mousedown (non click) per non perdere focus prima della selezione
            e.preventDefault();
            selectSuggest(idx);
          });

          list.appendChild(row);
        });
      }

      el("suggestBox").classList.remove("hidden");
      paintSuggestActive();
    }

    function paintSuggestActive(){
      const list = el("ddList");
      const children = Array.from(list.children);
      children.forEach((node, i) => {
        node.style.background = (i === state.suggestIndex) ? "rgba(122,162,247,.12)" : "transparent";
      });
    }

    function closeSuggest(){
      state.suggestOpen = false;
      state.suggestItems = [];
      state.suggestIndex = -1;
      el("suggestBox").classList.add("hidden");
      el("ddList").innerHTML = "";
    }

    function selectSuggest(idx){
      const it = state.suggestItems[idx];
      if(!it) return;

      // applico titolo+autore e salvo selezione per copertina/link
      el("title").value = it.title || "";
      el("author").value = it.author || "";
      state.selectedSuggestion = it;

      closeSuggest();
      setHint("Selezionato da Open Library. Puoi continuare a scrivere o salvare.", "ok");
    }

    async function fetchSuggestions(query){
      if(!state.lookupEnabled) return;
      if(state.editingId) return; // durante modifica, non faccio richieste automatiche
      const q = (query || "").trim();
      if(q.length < 2){
        closeSuggest();
        return;
      }

      const reqId = ++state.suggestReqId;
      setHint("Ricerca titoli/autori…", "warn");

      const url = "https://openlibrary.org/search.json?title=" + encodeURIComponent(q) + "&limit=10";
      let data;
      try{
        const res = await fetch(url);
        if(!res.ok) throw new Error("HTTP");
        data = await res.json();
      } catch {
        if(reqId !== state.suggestReqId) return;
        setHint("Lookup non disponibile (rete o blocco).", "warn");
        closeSuggest();
        return;
      }
      if(reqId !== state.suggestReqId) return;

      const docs = (data && Array.isArray(data.docs)) ? data.docs : [];
      const items = docs.slice(0, 10).map(d => {
        const title = d.title ? String(d.title) : "";
        const author = (d.author_name && d.author_name.length) ? String(d.author_name[0]) : "";
        const coverUrl = coverFromId(d.cover_i || null);
        const openLibraryKey = d.key ? String(d.key) : ""; // "/works/OL...W"
        const firstPublishYear = d.first_publish_year || "";
        const editionCount = d.edition_count || "";

        return { title, author, coverUrl, openLibraryKey, firstPublishYear, editionCount };
      });

      if(!items.length){
        showSuggest([], "Nessun risultato • continua a scrivere");
        setHint("Nessun match trovato. Continua a scrivere.", "warn");
        return;
      }

      showSuggest(items, "Suggerimenti (Open Library)");
      setHint("Suggerimenti pronti: usa ↑↓ e invio oppure clic.", "ok");
    }

    const onTitleType = debounce(() => fetchSuggestions(el("title").value), 250);
    el("title").addEventListener("input", () => {
      // se l’utente cambia titolo dopo una selezione, invalidiamo la selezione
      state.selectedSuggestion = null;
      onTitleType();
    });

    // tastiera: navigazione dropdown
    el("title").addEventListener("keydown", (e) => {
      if(!state.suggestOpen) return;

      if(e.key === "ArrowDown"){
        e.preventDefault();
        if(state.suggestItems.length){
          state.suggestIndex = Math.min(state.suggestIndex + 1, state.suggestItems.length - 1);
          paintSuggestActive();
        }
      } else if(e.key === "ArrowUp"){
        e.preventDefault();
        if(state.suggestItems.length){
          state.suggestIndex = Math.max(state.suggestIndex - 1, 0);
          paintSuggestActive();
        }
      } else if(e.key === "Enter"){
        // Se la tendina è aperta, Enter seleziona
        if(state.suggestIndex >= 0){
          e.preventDefault();
          selectSuggest(state.suggestIndex);
        }
      } else if(e.key === "Escape"){
        e.preventDefault();
        closeSuggest();
      }
    });

    // chiusura dropdown se clicchi fuori
    document.addEventListener("mousedown", (e) => {
      const box = el("suggestBox");
      const wrap = el("title").parentElement; // fieldWrap
      if(state.suggestOpen && !wrap.contains(e.target)){
        closeSuggest();
      }
    });

    // ----------------- RENDER LISTA -----------------
    function bookCard(book){
      const tags = (book.tags || []).filter(Boolean);
      const rating = book.rating ? `★ ${book.rating}/5` : "";

      const wrap = document.createElement("div");
      wrap.className = "item";

      const left = document.createElement("div");
      left.className = "meta";

      const t = document.createElement("div");
      t.className = "title";
      t.textContent = book.title || "(senza titolo)";

      const a = document.createElement("div");
      a.className = "small";
      a.textContent = [book.author, rating].filter(Boolean).join(" • ") || "—";

      const u = document.createElement("div");
      u.className = "small";
      const dt = book.updatedAt ? new Date(book.updatedAt) : null;
      u.textContent = dt ? ("Aggiornato: " + dt.toLocaleString("it-IT")) : "";

      const chips = document.createElement("div");
      chips.className = "chips";
      tags.slice(0, 8).forEach(tag => {
        const c = document.createElement("span");
        c.className = "chip";
        c.textContent = tag;
        chips.appendChild(c);
      });

      left.appendChild(t);
      left.appendChild(a);
      if(u.textContent) left.appendChild(u);
      if(tags.length) left.appendChild(chips);

      const actions = document.createElement("div");
      actions.className = "actions";

      const openBtn = document.createElement("button");
      openBtn.className = "secondary";
      openBtn.textContent = "Apri";
      openBtn.onclick = () => openBookModal(book);

      const cycleBtn = document.createElement("button");
      cycleBtn.className = "secondary";
      cycleBtn.textContent = "Cambia stato";
      cycleBtn.onclick = () => {
        const order = ["to-read","reading","read"];
        const i = order.indexOf(book.status);
        const next = order[(i + 1) % order.length];
        upsertBook({ ...book, status: next, updatedAt: nowIso() });
      };

      const delBtn = document.createElement("button");
      delBtn.className = "danger";
      delBtn.textContent = "Elimina";
      delBtn.onclick = () => {
        const ok = confirm(`Eliminare "${book.title}"?`);
        if(ok) removeBook(book.id);
      };

      actions.appendChild(openBtn);
      actions.appendChild(cycleBtn);
      actions.appendChild(delBtn);

      wrap.appendChild(left);
      wrap.appendChild(actions);
      return wrap;
    }

    function renderList(items){
      const lists = {
        "to-read": el("list-to-read"),
        "reading": el("list-reading"),
        "read": el("list-read")
      };
      Object.values(lists).forEach(node => node.innerHTML = "");

      items.forEach(book => {
        const target = lists[book.status] || lists["to-read"];
        target.appendChild(bookCard(book));
      });

      for(const node of Object.values(lists)){
        if(!node.children.length){
          const p = document.createElement("div");
          p.className = "small";
          p.textContent = "Nessun libro qui (per ora).";
          node.appendChild(p);
        }
      }
    }

    // ----------------- RENDER STANZA -----------------
    function fallbackGradient(seed){
      const s = (seed || "x").toString();
      let h = 0;
      for(let i=0;i<s.length;i++) h = (h*31 + s.charCodeAt(i)) >>> 0;
      const hue = h % 360;
      return `linear-gradient(180deg, hsl(${hue} 55% 55%), hsl(${(hue+25)%360} 55% 38%))`;
    }

    function makeTip(text){
      const tip = document.createElement("div");
      tip.className = "tip";
      tip.textContent = text;
      return tip;
    }

    function makeSpine(book, cls){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "bookBtn " + cls;
      btn.dataset.id = book.id;

      const cover = (book.coverUrl || "").trim();
      btn.style.backgroundImage = cover ? `url("${cover}")` : fallbackGradient(book.title + "|" + book.author);
      btn.style.position = "relative";

      const t = document.createElement("div");
      t.className = (cls === "spine") ? "spineTxt" : "miniTxt";
      t.textContent = (book.title || "").slice(0, 28);

      btn.appendChild(makeTip(`${book.title || ""}${book.author ? " — " + book.author : ""}`));

      if(cls === "spine"){
        const a = document.createElement("div");
        a.className = "spineSmall";
        a.textContent = (book.author || "").slice(0, 20);
        if(book.author) btn.appendChild(a);
      }
      btn.appendChild(t);
      return btn;
    }

    function makeHBook(book){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "bookBtn hbook";
      btn.dataset.id = book.id;

      const cover = (book.coverUrl || "").trim();
      btn.style.backgroundImage = cover ? `url("${cover}")` : fallbackGradient(book.title + "|" + book.author);

      const info = document.createElement("div");
      info.className = "hbookInfo";

      const t = document.createElement("div");
      t.className = "hbookTitle";
      t.textContent = book.title || "(senza titolo)";

      const a = document.createElement("div");
      a.className = "hbookAuthor";
      a.textContent = book.author || "—";

      info.appendChild(t);
      info.appendChild(a);

      btn.appendChild(makeTip(`${book.title || ""}${book.author ? " — " + book.author : ""}`));
      btn.appendChild(info);

      return btn;
    }

    function renderRoom(items){
      const read = items.filter(b => b.status === "read");
      const reading = items.filter(b => b.status === "reading");
      const toread = items.filter(b => b.status === "to-read");

      const R = el("room-read");
      const G = el("room-reading");
      const T = el("room-toread");

      R.innerHTML = "";
      G.innerHTML = "";
      T.innerHTML = "";

      if(!read.length){
        const p = document.createElement("div");
        p.className = "small";
        p.textContent = "Scaffale vuoto (per ora).";
        R.appendChild(p);
      }else{
        read.slice(0, 80).forEach(b => R.appendChild(makeSpine(b, "spine")));
      }

      if(!reading.length){
        const p = document.createElement("div");
        p.className = "small";
        p.textContent = "Nessun libro in lettura.";
        G.appendChild(p);
      }else{
        reading.slice(0, 24).forEach(b => G.appendChild(makeSpine(b, "miniSpine")));
      }

      if(!toread.length){
        const p = document.createElement("div");
        p.className = "small";
        p.textContent = "Nessun libro da leggere.";
        T.appendChild(p);
      }else{
        toread.slice(0, 24).forEach(b => T.appendChild(makeHBook(b)));
      }
    }

    // ----------------- MODAL -----------------
    function openUrl(url){
      if(!url) return;
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function openBookModal(book){
      el("modalTitle").textContent = book.title || "(senza titolo)";
      el("modalSub").textContent = book.author ? book.author : "Autore non valorizzato";

      el("modalStatus").textContent = statusLabel(book.status);
      el("modalRating").textContent = book.rating ? `${book.rating}/5` : "—";
      el("modalTags").textContent = (book.tags && book.tags.length) ? book.tags.join(", ") : "—";
      el("modalUpdated").textContent = book.updatedAt ? new Date(book.updatedAt).toLocaleString("it-IT") : "—";

      const cover = (book.coverUrl || "").trim();
      el("modalCover").style.backgroundImage = cover ? `url("${cover}")` : fallbackGradient(book.title + "|" + book.author);

      el("modalEdit").onclick = () => { setEditing(book); closeBookModal(); window.scrollTo({top:0, behavior:"smooth"}); };
      el("modalCycle").onclick = () => {
        const order = ["to-read","reading","read"];
        const i = order.indexOf(book.status);
        const next = order[(i+1)%order.length];
        upsertBook({ ...book, status: next, updatedAt: nowIso() });
        closeBookModal();
      };
      el("modalDelete").onclick = () => {
        const ok = confirm(`Eliminare "${book.title}"?`);
        if(ok) removeBook(book.id);
        closeBookModal();
      };

      const q = encodeURIComponent(`${book.title || ""} ${book.author || ""}`.trim());
      const ol = book.openLibraryKey ? openLibraryWorkUrl(book.openLibraryKey) : ("https://openlibrary.org/search?q=" + q);
      const audible = "https://www.audible.it/search?keywords=" + q;
      const kindle = "https://www.amazon.it/s?k=" + q + "&i=digital-text";

      el("modalOpenLibrary").onclick = () => openUrl(ol);
      el("modalAudible").onclick = () => openUrl(audible);
      el("modalKindle").onclick = () => openUrl(kindle);

      el("bookModal").classList.remove("hidden");
    }

    function closeBookModal(){ el("bookModal").classList.add("hidden"); }

    el("modalClose").addEventListener("click", closeBookModal);
    el("bookModal").addEventListener("click", (e) => {
      if(e.target && e.target.dataset && e.target.dataset.close) closeBookModal();
    });
    document.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && !el("bookModal").classList.contains("hidden")) closeBookModal();
    });

    el("viewRoom").addEventListener("click", (e) => {
      const btn = e.target.closest("[data-id]");
      if(!btn) return;
      const book = state.books.find(b => b.id === btn.dataset.id);
      if(book) openBookModal(book);
    });

    // ----------------- VISTA -----------------
    function setView(v){
      state.view = v;
      saveView();

      const isList = v === "list";
      el("viewList").classList.toggle("hidden", !isList);
      el("viewRoom").classList.toggle("hidden", isList);

      const bl = el("btnList");
      const br = el("btnRoom");
      if(isList){
        bl.classList.add("active"); bl.classList.remove("inactive");
        br.classList.add("inactive"); br.classList.remove("active");
      } else {
        br.classList.add("active"); br.classList.remove("inactive");
        bl.classList.add("inactive"); bl.classList.remove("active");
      }
    }

    // ----------------- RENDER -----------------
    function render(){
      const items = getFilteredSorted();
      const counts = { "to-read":0, "reading":0, "read":0 };
      items.forEach(b => { if(counts[b.status] !== undefined) counts[b.status]++; });

      el("counts").textContent =
        `Totale: ${items.length} • Da leggere: ${counts["to-read"]} • In lettura: ${counts["reading"]} • Letti: ${counts["read"]}`;

      renderList(items);
      renderRoom(items);
      setView(state.view);

      el("toggleLookup").textContent = state.lookupEnabled ? "Lookup ON" : "Lookup OFF";
    }

    // ----------------- EVENTI FORM -----------------
    el("saveBtn").addEventListener("click", () => {
      const title = el("title").value.trim();
      const status = el("status").value;

      if(!title){ alert("Titolo obbligatorio."); return; }

      const author = el("author").value.trim();
      const ratingRaw = el("rating").value;
      const rating = ratingRaw ? Number(ratingRaw) : null;
      const tags = parseTags(el("tags").value);
      const ts = nowIso();

      // Aggancio: se ho selezionato un suggerimento e il titolo coincide, salvo cover/link
      let coverUrl = "";
      let openLibraryKey = "";

      if(state.selectedSuggestion){
        // “coerenza”: se l’utente ha cambiato titolo dopo selezione, scarto
        if(normalize(state.selectedSuggestion.title) === normalize(title)){
          coverUrl = state.selectedSuggestion.coverUrl || "";
          openLibraryKey = state.selectedSuggestion.openLibraryKey || "";
        }
      }

      if(state.editingId){
        const existing = state.books.find(b => b.id === state.editingId);
        if(!existing){ clearForm(); return; }
        upsertBook({
          ...existing,
          title, author, status, rating, tags,
          coverUrl: existing.coverUrl || coverUrl,
          openLibraryKey: existing.openLibraryKey || openLibraryKey,
          updatedAt: ts
        });
      } else {
        upsertBook({
          id: uid(),
          title, author, status, rating, tags,
          coverUrl, openLibraryKey,
          createdAt: ts,
          updatedAt: ts
        });
      }

      clearForm();
    });

    el("cancelEditBtn").addEventListener("click", clearForm);

    el("search").addEventListener("input", (e) => { state.search = e.target.value; render(); });
    el("sort").addEventListener("change", (e) => { state.sort = e.target.value; render(); });

    el("btnList").addEventListener("click", () => setView("list"));
    el("btnRoom").addEventListener("click", () => setView("room"));

    el("toggleLookup").addEventListener("click", () => {
      state.lookupEnabled = !state.lookupEnabled;
      saveLookup();
      if(!state.lookupEnabled){
        setHint("Lookup disattivato.", "warn");
        closeSuggest();
      } else {
        setHint("Lookup attivo: digita un titolo e scegli dalla tendina.", "ok");
        fetchSuggestions(el("title").value);
      }
      render();
    });

    el("exportBtn").addEventListener("click", () => {
      el("exportText").value = JSON.stringify(state.books, null, 2);
      el("exportArea").classList.remove("hidden");
      el("importArea").classList.add("hidden");
    });
    el("closeExportBtn").addEventListener("click", () => el("exportArea").classList.add("hidden"));

    el("importBtn").addEventListener("click", () => {
      el("importText").value = "";
      el("importArea").classList.remove("hidden");
      el("exportArea").classList.add("hidden");
    });
    el("cancelImportBtn").addEventListener("click", () => el("importArea").classList.add("hidden"));

    el("confirmImportBtn").addEventListener("click", () => {
      try{
        const parsed = JSON.parse(el("importText").value);
        if(!Array.isArray(parsed)) throw new Error("JSON non è una lista");
        state.books = parsed.filter(x => x && typeof x === "object").map(x => ({
          id: x.id || uid(),
          title: (x.title || "").toString(),
          author: (x.author || "").toString(),
          status: ["to-read","reading","read"].includes(x.status) ? x.status : "to-read",
          rating: (x.rating === null || x.rating === undefined || x.rating === "") ? null : Number(x.rating),
          tags: Array.isArray(x.tags) ? x.tags.map(t => t.toString()) : [],
          coverUrl: (x.coverUrl || "").toString(),
          openLibraryKey: (x.openLibraryKey || "").toString(),
          createdAt: x.createdAt || nowIso(),
          updatedAt: x.updatedAt || nowIso()
        }));
        save();
        el("importArea").classList.add("hidden");
        render();
      } catch(err){
        alert("Import fallito: " + (err?.message || "errore"));
      }
    });

    el("wipeBtn").addEventListener("click", () => {
      const ok = confirm("Eliminare TUTTI i libri salvati in questo browser?");
      if(!ok) return;
      state.books = [];
      save();
      clearForm();
      render();
    });

    // Init
    load();
    setView(state.view);
    render();
    setHint(state.lookupEnabled ? "Lookup attivo: digita un titolo e scegli dalla tendina." : "Lookup disattivato.", state.lookupEnabled ? "ok" : "warn");
  </script>
</body>
</html>
