<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Libreria 3.0 - Google Books & Real 3D</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;500;800&family=Libre+Baskerville:ital@0;1&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg-color: #050505;
      --wood-dark: #2a1b15;
      --wood-light: #4a3b32;
      --wood-top: #5c4033;
      --shadow-shelf: rgba(0,0,0,0.8);
      
      --ui-glass: rgba(20, 20, 24, 0.85);
      --ui-border: rgba(255,255,255,0.1);
      --accent: #d4af37; /* Oro antico */
    }

    body{
      margin:0; overflow:hidden; background:var(--bg-color);
      font-family: 'Inter', sans-serif; color:white;
      height:100vh; width:100vw;
    }

    /* --- LAYOUT GENERALE --- */
    .app-wrapper{
      position: relative; width:100%; height:100%;
      display: flex; flex-direction: column;
    }

    /* HEADER MINIMAL */
    header{
      position: absolute; top:0; left:0; right:0; z-index: 1000;
      display:flex; justify-content:space-between; align-items:center;
      padding: 15px 30px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
      pointer-events: none; /* Lascia cliccare la stanza sotto */
    }
    header * { pointer-events: auto; } /* Riattiva click sui bottoni */

    h1{ font-family: 'Cinzel', serif; font-size: 20px; color: var(--accent); margin:0; text-shadow:0 2px 10px black;}
    
    .actions button{
      background: var(--ui-glass); border: 1px solid var(--ui-border);
      color: #eee; padding: 8px 16px; border-radius: 6px; cursor: pointer;
      backdrop-filter: blur(10px); transition: .2s; font-size:12px;
    }
    .actions button:hover{ background: white; color:black; }
    .actions button.primary{ border-color: var(--accent); color: var(--accent); }
    .actions button.primary:hover{ background: var(--accent); color: black; }

    /* --- SCENA 3D (IL CUORE) --- */
    .room-viewport{
      flex: 1; position: relative; overflow: hidden;
      perspective: 1200px; /* Profondità di campo */
      display: flex; align-items: flex-end; justify-content: center;
    }

    /* Sfondo Atmosferico (Muro/Finestra) */
    .room-bg-layer{
      position: absolute; inset: -50px; 
      background-image: url('./assets/room.jpg'); 
      background-size: cover; background-position: center;
      filter: brightness(0.4) blur(0px); z-index: 0;
      /* Se l'utente non ha l'immagine, usiamo un gradiente elegante */
      background-color: #1a1a1a;
    }

    /* COSTRUZIONE LIBRERIA PROCEDURALE */
    .bookshelf-container{
      position: relative; z-index: 10;
      width: 90%; max-width: 1200px;
      height: 85%;
      margin-bottom: 0;
      transform-style: preserve-3d;
      transform: rotateX(5deg); /* Leggera inclinazione dal basso per imponenza */
      transition: transform 0.5s ease;
      display: flex; flex-direction: column; justify-content: flex-end;
    }

    /* Singolo Scaffale (Legno) */
    .shelf-row{
      position: relative;
      height: 160px; /* Altezza spazio libri */
      width: 100%;
      margin-bottom: 20px;
      transform-style: preserve-3d;
      border-bottom: 25px solid var(--wood-dark); /* Spessore legno frontale */
      box-shadow: 0 30px 40px var(--shadow-shelf);
      background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); /* Ombra interna */
      display: flex; align-items: flex-end; padding: 0 40px; gap: 4px;
    }

    /* Piano d'appoggio (Top del legno) */
    .shelf-row::after{
      content:''; position: absolute; bottom: -25px; left: 0; width: 100%; height: 60px;
      background: var(--wood-top);
      transform-origin: top; transform: rotateX(90deg);
      box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
    }
    
    /* Spalle laterali (Montanti) */
    .bookshelf-container::before, .bookshelf-container::after{
      content:''; position: absolute; top:0; bottom:0; width: 40px;
      background: var(--wood-light); transform-style: preserve-3d;
      box-shadow: inset 0 0 20px black;
    }
    .bookshelf-container::before{ left: -40px; transform: rotateY(90deg); transform-origin: right;}
    .bookshelf-container::after{ right: -40px; transform: rotateY(-90deg); transform-origin: left;}


    /* --- LIBRI 3D AVANZATI --- */
    .book-spine{
      position: relative;
      width: 32px; /* Larghezza standard dorso */
      height: 130px; /* Altezza base */
      border-radius: 2px 4px 4px 2px;
      cursor: pointer;
      transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1);
      transform-origin: bottom center;
      /* Texture dorso generica fallback */
      background: linear-gradient(to right, #444, #666 20%, #444 40%, #222);
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }

    .book-spine:hover{
      transform: scale(1.05) translateZ(20px); z-index: 100;
    }

    /* Etichetta titolo sul dorso */
    .spine-label{
      position: absolute; inset:0; 
      writing-mode: vertical-rl; text-orientation: mixed;
      display: flex; align-items: center; justify-content: center;
      font-family: 'Libre Baskerville', serif;
      font-size: 9px; color: rgba(255,255,255,0.8);
      text-shadow: 0 1px 2px black;
      padding: 5px 0; overflow: hidden;
      white-space: nowrap; text-overflow: ellipsis;
    }
    
    /* Varianti di colore generate via JS */
    .bk-red   { background: linear-gradient(to right, #5c1818, #8a2b2b 25%, #4a1010); }
    .bk-blue  { background: linear-gradient(to right, #182b5c, #2b458a 25%, #101c4a); }
    .bk-green { background: linear-gradient(to right, #185c2b, #2b8a45 25%, #104a20); }
    .bk-black { background: linear-gradient(to right, #222, #444 25%, #111); }
    .bk-white { background: linear-gradient(to right, #ccc, #eee 25%, #bbb); color:#111; }
    .bk-white .spine-label { color: #222; text-shadow:none; }


    /* --- INTERFACCIA GESTIONE (A SCOMPARSA) --- */
    .manager-panel{
      position: fixed; top: 70px; right: 30px; bottom: 30px; width: 400px;
      background: var(--ui-glass);
      border: 1px solid var(--ui-border);
      border-radius: 12px;
      backdrop-filter: blur(20px);
      box-shadow: -20px 0 60px rgba(0,0,0,0.7);
      transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      z-index: 2000;
      display: flex; flex-direction: column;
    }
    .manager-panel.open{ transform: translateX(0); }

    .mp-header{ padding: 20px; border-bottom: 1px solid var(--ui-border); display:flex; justify-content:space-between; align-items:center;}
    .mp-body{ flex:1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
    
    /* Search Box */
    .search-group{ position: relative; }
    .search-input{
      width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--ui-border);
      padding: 12px; color: white; border-radius: 8px; font-family: inherit;
    }
    .search-input:focus{ border-color: var(--accent); outline: none; }
    
    .results-dropdown{
      margin-top: 10px; background: #1a1a1a; border-radius: 8px; overflow: hidden;
      max-height: 0; transition: max-height 0.3s;
    }
    .results-dropdown.has-data{ max-height: 300px; overflow-y: auto; border: 1px solid var(--ui-border); }
    
    .res-item{
      display: flex; gap: 10px; padding: 10px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05);
      transition: background .2s;
    }
    .res-item:hover{ background: rgba(255,255,255,0.1); }
    .res-img{ width: 40px; height: 60px; object-fit: cover; background: #333; }

    /* Form Details */
    .form-row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    label{ font-size:11px; text-transform: uppercase; color: #888; margin-bottom: 5px; display:block;}
    select, textarea{ width:100%; background: rgba(0,0,0,0.3); border: 1px solid var(--ui-border); color:white; padding:10px; border-radius:6px; }

    /* --- MODAL DETTAGLIO --- */
    .detail-overlay{
      position: fixed; inset:0; background: rgba(0,0,0,0.8); z-index: 3000;
      display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(5px);
    }
    .detail-overlay.active{ opacity: 1; pointer-events: auto; }
    
    .book-detail-card{
      background: #151515; width: 600px; max-width: 90%;
      border: 1px solid var(--ui-border); border-radius: 12px;
      display: grid; grid-template-columns: 200px 1fr; overflow: hidden;
      box-shadow: 0 50px 100px black; transform: scale(0.9); transition: transform 0.3s;
    }
    .detail-overlay.active .book-detail-card{ transform: scale(1); }
    
    .bd-cover{ width: 100%; height: 100%; object-fit: cover; background: #222; }
    .bd-info{ padding: 30px; display: flex; flex-direction: column; }
    .bd-title{ font-family: 'Cinzel', serif; font-size: 24px; margin: 0 0 5px 0; color: var(--accent); line-height: 1.2;}
    .bd-meta{ font-size: 14px; color: #888; margin-bottom: 20px; }
    .bd-comment{ flex: 1; font-style: italic; color: #ccc; line-height: 1.6; font-size: 14px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }
    
    .bd-actions{ margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end; }


  </style>
</head>
<body>

<div class="app-wrapper">
  
  <header>
    <h1>BIBLIOTHECA <span style="font-size:12px; color:#666; font-family:sans-serif; letter-spacing:1px; margin-left:10px;">3.0</span></h1>
    <div class="actions">
      <button onclick="exportJSON()">Backup Dati</button>
      <button class="primary" onclick="toggleManager()">+ Aggiungi / Gestisci</button>
    </div>
  </header>

  <div class="room-viewport" id="roomScene">
    <div class="room-bg-layer"></div> <div class="bookshelf-container" id="bookshelf">
       </div>
  </div>

  <div class="manager-panel" id="managerPanel">
    <div class="mp-header">
      <h3 style="margin:0">Gestione Biblioteca</h3>
      <button onclick="toggleManager()" style="background:transparent; border:none; color:#888; cursor:pointer; font-size:20px;">✕</button>
    </div>
    
    <div class="mp-body">
      <div class="search-group">
        <label>Cerca Nuovi Libri (Google Books API)</label>
        <input class="search-input" id="inpSearch" placeholder="Es. Italo Calvino, Adelphi..." autocomplete="off">
        <div class="results-dropdown" id="searchResults"></div>
      </div>

      <hr style="border:0; border-top:1px solid var(--ui-border); width:100%;">

      <div>
        <label>Titolo Selezionato</label>
        <div id="selTitle" style="font-weight:bold; margin-bottom:10px; color:var(--accent);">Nessun libro selezionato</div>
        
        <div class="form-row">
           <div>
             <label>Autore</label>
             <input id="inpAuthor" class="search-input" style="padding:8px;" readonly>
           </div>
           <div>
             <label>Pagine</label>
             <input id="inpPages" class="search-input" style="padding:8px;" readonly>
           </div>
        </div>
        
        <div class="form-row" style="margin-top:15px;">
           <div>
             <label>Stato</label>
             <select id="inpStatus">
               <option value="read">Letto (Scaffale)</option>
               <option value="reading">In Lettura</option>
               <option value="toread">Da Leggere</option>
             </select>
           </div>
           <div>
             <label>Colore Dorso</label>
             <select id="inpColor">
               <option value="bk-red">Rosso Antico</option>
               <option value="bk-blue">Blu Notte</option>
               <option value="bk-green">Verde Bosco</option>
               <option value="bk-black">Nero Pelle</option>
               <option value="bk-white">Pergamena</option>
             </select>
           </div>
        </div>

        <div style="margin-top:15px;">
          <label>Note / Recensione</label>
          <textarea id="inpNote" rows="3"></textarea>
        </div>

        <button class="primary" style="width:100%; margin-top:20px; padding:12px;" onclick="saveBook()">Salva nella Libreria</button>
        <div id="saveMsg" style="text-align:center; color:#4ade80; margin-top:5px; opacity:0; transition:0.3s;">Salvato con successo</div>
      </div>
    </div>
  </div>

</div>

<div class="detail-overlay" id="detailOverlay" onclick="if(event.target===this) closeDetail()">
  <div class="book-detail-card">
    <img src="" id="d-cover" class="bd-cover">
    <div class="bd-info">
      <div class="bd-title" id="d-title">Titolo</div>
      <div class="bd-meta">di <span id="d-author" style="color:white;">Autore</span> &bull; <span id="d-publisher">Editore</span></div>
      
      <div class="bd-comment" id="d-comment">
        Nessuna nota.
      </div>

      <div class="bd-actions">
        <button onclick="deleteBook()" style="background:#311; color:#f87171; border:1px solid #522; padding:8px 16px; border-radius:6px; cursor:pointer;">Elimina</button>
        <button onclick="closeDetail()" class="primary" style="background:var(--accent); color:black; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold;">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<script>
/* --- CONFIGURAZIONE & DB --- */
const LS_KEY = "library_v3_google";
let books = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
let tempBookData = null;
let currentFocusId = null;

// --- GOOGLE BOOKS API (THE GAME CHANGER) ---
const inpSearch = document.getElementById('inpSearch');
const resBox = document.getElementById('searchResults');
let searchTimer;

inpSearch.addEventListener('input', (e) => {
  clearTimeout(searchTimer);
  const q = e.target.value.trim();
  if(q.length < 3) { resBox.classList.remove('has-data'); return; }

  searchTimer = setTimeout(async () => {
    // Cerchiamo specificatamente libri in lingua italiana o rilevanti
    // langRestrict=it aiuta molto per Calvino, Eco, ecc.
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&langRestrict=it&maxResults=10&printType=books`;
    
    try {
      const req = await fetch(url);
      const data = await req.json();
      
      if(data.items) {
        resBox.innerHTML = data.items.map(item => {
          const info = item.volumeInfo;
          const img = info.imageLinks?.smallThumbnail || '';
          return `
            <div class="res-item" onclick='selectBook(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
              <img class="res-img" src="${img}">
              <div>
                <div style="font-weight:bold; font-size:13px; color:white;">${info.title}</div>
                <div style="font-size:11px; color:#aaa;">${info.authors?.[0] || '?'} - ${info.publisher || ''}</div>
              </div>
            </div>
          `;
        }).join('');
        resBox.classList.add('has-data');
      }
    } catch(err) { console.error(err); }
  }, 500);
});

function selectBook(apiData) {
  const info = apiData.volumeInfo;
  
  // Prepara oggetto temporaneo
  tempBookData = {
    title: info.title,
    author: info.authors?.[0] || "Sconosciuto",
    publisher: info.publisher || "Editore non noto",
    pages: info.pageCount || 150, // Fallback per spessore libro
    cover: info.imageLinks?.thumbnail?.replace('http:', 'https:') || '', // High res se possibile
    googleId: apiData.id
  };

  // Popola UI
  document.getElementById('selTitle').textContent = tempBookData.title;
  document.getElementById('inpAuthor').value = tempBookData.author;
  document.getElementById('inpPages').value = tempBookData.pages + " pag.";
  
  // Assegna colore casuale in base al genere o titolo se vuoi, qui random
  const colors = ['bk-red','bk-blue','bk-green','bk-black','bk-white'];
  document.getElementById('inpColor').value = colors[Math.floor(Math.random()*colors.length)];

  resBox.classList.remove('has-data');
  inpSearch.value = "";
}

// --- SALVATAGGIO ---
function saveBook() {
  if(!tempBookData) return alert("Seleziona prima un libro dalla ricerca!");
  
  const newBook = {
    id: crypto.randomUUID(),
    ...tempBookData,
    status: document.getElementById('inpStatus').value,
    styleClass: document.getElementById('inpColor').value,
    note: document.getElementById('inpNote').value,
    addedAt: Date.now()
  };

  books.push(newBook);
  localStorage.setItem(LS_KEY, JSON.stringify(books));
  
  // Feedback visivo
  const msg = document.getElementById('saveMsg');
  msg.style.opacity = 1;
  setTimeout(() => msg.style.opacity = 0, 2000);
  
  // Reset parziale
  tempBookData = null;
  document.getElementById('selTitle').textContent = "Pronto per il prossimo";
  document.getElementById('inpNote').value = "";
  
  renderLibrary3D();
}

function deleteBook() {
  if(!currentFocusId) return;
  if(!confirm("Rimuovere questo libro?")) return;
  
  books = books.filter(b => b.id !== currentFocusId);
  localStorage.setItem(LS_KEY, JSON.stringify(books));
  closeDetail();
  renderLibrary3D();
}

// --- MOTORE DI RENDERING 3D (PROCEDURALE) ---
function renderLibrary3D() {
  const shelfContainer = document.getElementById('bookshelf');
  shelfContainer.innerHTML = ''; // Pulisci scena

  // Filtra solo libri "fisici" (Letto/Da Leggere). 
  // Quelli "In lettura" potremmo metterli su un tavolo separato in futuro (v4.0)
  // Per ora li mettiamo tutti sugli scaffali per riempire la stanza.
  const shelfBooks = books.sort((a,b) => b.addedAt - a.addedAt);

  if(shelfBooks.length === 0) {
    // Messaggio vuoto elegante
    shelfContainer.innerHTML = `<div style="text-align:center; margin-top:100px; color:#555; font-family:'Cinzel'">La biblioteca è vuota.<br>Aggiungi volumi dal pannello.</div>`;
    return;
  }

  // Calcoliamo quanti scaffali servono. Ipotizziamo max 15 libri per scaffale.
  const BOOKS_PER_SHELF = 15;
  const numShelves = Math.ceil(shelfBooks.length / BOOKS_PER_SHELF);
  
  let bookIndex = 0;

  // Genera Righe Scaffale
  for(let i=0; i<numShelves; i++) {
    const row = document.createElement('div');
    row.className = 'shelf-row';
    
    // Riempi la riga
    for(let j=0; j<BOOKS_PER_SHELF; j++) {
      if(bookIndex >= shelfBooks.length) break;
      
      const b = shelfBooks[bookIndex];
      const spine = document.createElement('div');
      
      // Classi base + colore scelto
      spine.className = `book-spine ${b.styleClass}`;
      
      // Calcolo spessore basato sulle pagine (min 20px, max 60px)
      const thickness = Math.max(24, Math.min(b.pages / 10, 50)); 
      spine.style.width = `${thickness}px`;
      
      // Calcolo altezza random per realismo (tra 85% e 98% dello scaffale)
      const height = 85 + (b.title.length % 14); 
      spine.style.height = `${height}%`;

      // Etichetta
      spine.innerHTML = `<span class="spine-label">${b.title}</span>`;
      
      // Interazione
      spine.onclick = () => openDetail(b);

      row.appendChild(spine);
      bookIndex++;
    }
    
    // Aggiungi riga (appendendo in cima per ordine logico visivo o bottom up)
    shelfContainer.appendChild(row);
  }
}

// --- GESTIONE UI ---
function toggleManager() {
  document.getElementById('managerPanel').classList.toggle('open');
}

function openDetail(book) {
  currentFocusId = book.id;
  document.getElementById('d-cover').src = book.cover || '';
  document.getElementById('d-title').textContent = book.title;
  document.getElementById('d-author').textContent = book.author;
  document.getElementById('d-publisher').textContent = book.publisher;
  document.getElementById('d-comment').textContent = book.note || "Nessuna nota personale.";
  
  document.getElementById('detailOverlay').classList.add('active');
}

function closeDetail() {
  document.getElementById('detailOverlay').classList.remove('active');
  currentFocusId = null;
}

function exportJSON() {
  const data = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(books));
  const a = document.createElement('a');
  a.href = data; a.download = 'biblioteca_backup.json';
  a.click();
}

// --- AVVIO ---
renderLibrary3D();

// Apri il manager se vuoto
if(books.length === 0) setTimeout(toggleManager, 1000);

</script>
</body>
</html>
