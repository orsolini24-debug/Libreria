<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Libreria Immersiva v1.3</title>
  <style>
    :root{
      --bg:#050505;
      /* Glassmorphism panel */
      --panel:rgba(20, 25, 35, 0.7);
      --panel-border:rgba(255,255,255,0.1);
      --text:#e9eef6;
      --muted:#9aa8bd;
      --accent:#7aa2ff;
      --shadow:0 10px 40px rgba(0,0,0,0.8);
      --font:system-ui,-apple-system,sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--font); color:var(--text); background:var(--bg);
      min-height:100vh; overflow-x:hidden;
    }

    /* Sfondo generale (quando non sei in Stanza) */
    body:not(.is-room)::before{
      content:""; position:fixed; inset:0; z-index:-1;
      background: radial-gradient(circle at 50% 0%, #1e293b 0%, #000 70%);
    }

    .wrap{ max-width:1400px; margin:0 auto; padding:20px; position:relative; z-index:1; }

    /* HEADER & NAV */
    header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; backdrop-filter:blur(5px); }
    .title h1{ margin:0; font-size:22px; font-weight:700; letter-spacing:-0.5px; }
    
    .nav-pills{ display:flex; background:rgba(255,255,255,0.05); padding:4px; border-radius:12px; border:1px solid var(--panel-border); }
    .nav-btn{
      background:transparent; border:0; color:var(--muted); padding:6px 16px; 
      font-weight:600; font-size:13px; cursor:pointer; border-radius:8px; transition:all .2s;
    }
    .nav-btn.active{ background:rgba(255,255,255,0.1); color:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.2); }

    .btn{
      padding:8px 16px; border-radius:8px; border:1px solid var(--panel-border);
      background:rgba(255,255,255,0.05); color:#fff; cursor:pointer; font-size:13px; font-weight:600;
      transition:all .2s;
    }
    .btn:hover{ background:rgba(255,255,255,0.15); }
    .btn.primary{ background:var(--accent); border-color:var(--accent); color:#000; }

    /* LAYOUT SWITCHER */
    .view-section{ display:none; animation:fadeIn .3s ease; }
    .view-section.active{ display:block; }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    /* --- VISTA LISTA (Classica) --- */
    .form-panel{
      background:var(--panel); border:1px solid var(--panel-border); border-radius:16px;
      padding:20px; backdrop-filter:blur(20px); margin-bottom:20px;
      display:grid; grid-template-columns: 2fr 1fr auto; gap:15px; align-items:end;
    }
    
    input, select{
      width:100%; background:rgba(0,0,0,0.4); border:1px solid var(--panel-border);
      color:#fff; padding:12px; border-radius:10px; outline:none; font-size:14px;
    }
    input:focus{ border-color:var(--accent); }
    
    .list-grid{ display:grid; grid-template-columns:repeat(auto-fill, minmax(300px, 1fr)); gap:15px; }
    .book-card{
      display:flex; gap:15px; background:rgba(255,255,255,0.03); border:1px solid var(--panel-border);
      padding:12px; border-radius:12px; cursor:pointer; transition:background .2s;
    }
    .book-card:hover{ background:rgba(255,255,255,0.08); }
    .bc-img{ width:50px; height:75px; object-fit:cover; border-radius:4px; background:#222; }
    
    /* --- VISTA STANZA (IMMERSIVA) --- */
    .room-container{
      position:relative; width:100%; aspect-ratio: 16 / 9; /* Forza aspetto widescreen */
      background:#000; border-radius:20px; overflow:hidden;
      box-shadow: 0 0 0 1px var(--panel-border), 0 50px 100px #000;
    }
    
    .room-bg{
      width:100%; height:100%; object-fit:cover;
      /* Filtro per scurire leggermente e integrare meglio gli elementi */
      filter: brightness(0.7) contrast(1.1);
      transform: scale(1.02); /* Evita bordi bianchi */
    }

    /* ZONE DELIMITATE - Ora usiamo Flexbox precisi */
    .zone{
      position:absolute; 
      /* Debug visuale: passa col mouse sulla stanza per vedere le griglie */
      border:1px dashed rgba(255,255,255,0.0);
      transition: border-color .3s;
    }
    .room-container:hover .zone{ border-color:rgba(255,255,255,0.1); }

    /* 1. SCAFFALE ALTO (Libri Letti) - Posizionamento Dorsi */
    .zone-shelf-high {
      top: 18%; left: 52%; width: 28%; height: 11%; /* Coordinate ipotetiche stanza standard */
      display:flex; align-items:flex-end; justify-content:flex-start; gap:1px;
      perspective: 600px;
    }

    /* 2. SCAFFALE BASSO (Da Leggere) */
    .zone-shelf-low {
      top: 34%; left: 52%; width: 28%; height: 11%;
      display:flex; align-items:flex-end; justify-content:flex-start; gap:1px;
    }

    /* 3. TAVOLO (In Lettura) - Prospettiva 3D */
    .zone-table {
      bottom: 15%; left: 20%; width: 40%; height: 25%;
      display:flex; align-items:center; justify-content:center; gap:20px;
      perspective: 1000px; /* Magia 3D */
      z-index: 10;
    }

    /* 4. WISHLIST (Angolo/Pavimento/Altro scaffale) */
    .zone-wish {
      bottom: 5%; right: 5%; width: 15%; height: 15%;
      display:grid; grid-template-columns:repeat(3, 1fr); gap:5px;
      opacity: 0.8; transform: rotate(-5deg);
    }

    /* --- OGGETTI LIBRO --- */
    
    /* STILE A: DORSO (Per scaffali) */
    .spine-book {
      width: 16px; /* Spessore libro */
      height: 90%; /* Altezza relativa allo scaffale */
      background: linear-gradient(to right, #444, #222 20%, #444 40%, #222);
      border-radius: 2px;
      cursor:pointer;
      position:relative;
      transition: transform .2s, height .2s;
      box-shadow: 1px 0 2px rgba(0,0,0,0.5);
    }
    .spine-book:hover { transform: translateY(-5px) scale(1.1); z-index:100; background:#555; }
    /* Etichetta titolo che appare solo in hover */
    .spine-book::after {
      content: attr(title);
      position:absolute; bottom:100%; left:50%; transform:translateX(-50%);
      background:black; color:white; padding:4px 8px; font-size:10px; 
      white-space:nowrap; border-radius:4px; pointer-events:none; opacity:0;
    }
    .spine-book:hover::after{ opacity:1; }

    /* STILE B: COPERTINA 3D (Per tavolo) */
    .table-book {
      width: 100px; aspect-ratio: 2/3;
      position: relative;
      transform-style: preserve-3d;
      transform: rotateX(50deg) rotateZ(-10deg) translateZ(0); /* Appoggiato sul tavolo */
      box-shadow: -10px 20px 20px rgba(0,0,0,0.6); /* Ombra realistica distante */
      transition: transform .3s;
      cursor: pointer;
      border-radius: 4px 10px 10px 4px; /* Simula curvatura pagine */
      background: #fff;
    }
    .table-book img {
      width:100%; height:100%; object-fit:cover; border-radius:2px;
    }
    .table-book:hover {
      transform: rotateX(0deg) rotateZ(0deg) scale(1.1) translateZ(50px); /* Si alza in piedi */
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      z-index: 100;
    }

    /* STILE C: MINIATURA (Wishlist) */
    .wish-book { width:100%; aspect-ratio:2/3; background:#333; opacity:0.6; border:1px dashed #fff; cursor:pointer; }
    .wish-book:hover { opacity:1; transform:scale(1.1); }


    /* --- MODAL FOCUS --- */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9999;
      display:none; align-items:center; justify-content:center; backdrop-filter:blur(8px);
    }
    .overlay.on{ display:flex; }
    
    .focus-panel{
      width:90%; max-width:500px; background:#1a1d24; border:1px solid var(--panel-border);
      border-radius:20px; padding:30px; box-shadow:0 50px 100px #000;
      display:flex; flex-direction:column; gap:20px;
    }
    
    .fp-head{ display:flex; gap:20px; }
    .fp-cover{ width:120px; height:180px; object-fit:cover; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,0.5); }
    .fp-info h2{ margin:0 0 5px; font-size:20px; line-height:1.2; }
    .fp-info p{ color:var(--muted); margin:0; font-size:14px; }
    
    .fp-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    
    /* DROPDOWN RICERCA FIX */
    .search-wrap{ position:relative; }
    .dropdown{
      position:absolute; top:110%; left:0; right:0; background:#222; 
      border:1px solid var(--panel-border); border-radius:10px; z-index:500;
      max-height:300px; overflow-y:auto; display:none; box-shadow:0 20px 50px rgba(0,0,0,1);
    }
    .dd-item{ padding:10px; display:flex; gap:10px; cursor:pointer; border-bottom:1px solid #333; }
    .dd-item:hover{ background:#333; }
    
    /* Toast notifica */
    .toast{ 
        position:fixed; bottom:20px; right:20px; background:var(--accent); color:#000; 
        padding:10px 20px; border-radius:8px; font-weight:bold; transform:translateY(100px); transition:0.3s;
    }
    .toast.on{ transform:translateY(0); }

  </style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="title">
      <h1>My Library</h1>
      <span style="font-size:12px; color:var(--muted);">Versione Immersiva 1.3</span>
    </div>
    
    <div class="nav-pills">
      <button class="nav-btn active" onclick="switchView('list')">Lista Dati</button>
      <button class="nav-btn" onclick="switchView('room')">Stanza 3D</button>
    </div>
    
    <button class="btn" onclick="exportData()">Backup JSON</button>
  </header>

  <div id="view-list" class="view-section active">
    
    <div class="form-panel">
      <div class="search-wrap">
        <label style="font-size:11px; color:var(--muted); text-transform:uppercase;">Cerca Libro (OpenLibrary)</label>
        <input type="text" id="inpSearch" placeholder="Es. 1984, Orwell..." autocomplete="off">
        <div class="dropdown" id="ddResults"></div>
      </div>
      
      <div>
        <label style="font-size:11px; color:var(--muted); text-transform:uppercase;">Stato</label>
        <select id="inpStatus">
          <option value="to_read">ðŸ“š Da Leggere (Scaffale Basso)</option>
          <option value="reading">ðŸ“– In Lettura (Tavolo)</option>
          <option value="read">âœ… Letto (Scaffale Alto)</option>
          <option value="wishlist">ðŸ’¸ Wishlist (Angolo)</option>
        </select>
      </div>
      
      <button class="btn primary" onclick="saveBook()" style="height:44px;">Salva Libro</button>
    </div>

    <div class="list-grid" id="listContainer"></div>
  </div>

  <div id="view-room" class="view-section">
    <div class="room-container">
      <img src="./assets/room.jpg" class="room-bg" onerror="this.style.display='none'; document.querySelector('.room-container').style.background='#222'">
      
      <div class="zone zone-shelf-high" id="shelfHigh" title="Libri Letti"></div>
      
      <div class="zone zone-shelf-low" id="shelfLow" title="Da Leggere"></div>
      
      <div class="zone zone-table" id="tableZone" title="In Lettura"></div>
      
      <div class="zone zone-wish" id="wishZone" title="Wishlist"></div>
      
      <div style="position:absolute; top:20px; left:20px; color:rgba(255,255,255,0.5); font-size:12px; pointer-events:none;">
        Passa il mouse per evidenziare le zone
      </div>
    </div>
  </div>

</div>

<div class="overlay" id="focusOverlay" onclick="if(event.target===this) closeFocus()">
  <div class="focus-panel">
    <div class="fp-head">
      <img src="" id="fpCover" class="fp-cover">
      <div class="fp-info">
        <h2 id="fpTitle">Titolo</h2>
        <p id="fpAuthor">Autore</p>
        <div style="margin-top:10px;">
             <span id="fpStatusBadge" style="padding:4px 8px; border-radius:4px; font-size:11px; border:1px solid #555;">Stato</span>
        </div>
        <p id="fpComment" style="margin-top:15px; font-style:italic; opacity:0.7;">...</p>
      </div>
    </div>
    <div class="fp-actions">
      <button class="btn" onclick="cycleStatus()">Sposta Libro</button>
      <button class="btn" style="border-color:#fb7185; color:#fb7185;" onclick="deleteCurrent()">Elimina</button>
      <div style="flex:1"></div>
      <button class="btn" onclick="searchAmazon()">Amazon</button>
    </div>
  </div>
</div>

<div class="toast" id="toast">Salvato!</div>

<script>
// --- DATI E STATO ---
const LS_KEY = "library_v1_3";
let books = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
let tempBook = null; 
let currentId = null;

// --- GESTIONE VISTE ---
function switchView(viewName) {
  document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
  
  document.getElementById('view-'+viewName).classList.add('active');
  // Trova il bottone corretto (semplificato)
  if(viewName === 'list') document.querySelector('.nav-btn:first-child').classList.add('active');
  else document.querySelector('.nav-btn:last-child').classList.add('active');

  document.body.classList.toggle('is-room', viewName === 'room');
  
  if(viewName === 'list') renderList();
  if(viewName === 'room') renderRoom();
}

// --- LOGICA RICERCA (OpenLibrary) ---
const inpSearch = document.getElementById('inpSearch');
const ddResults = document.getElementById('ddResults');
let timer;

inpSearch.addEventListener('input', (e) => {
  clearTimeout(timer);
  const q = e.target.value.trim();
  if(q.length < 3) { ddResults.style.display='none'; return; }
  
  timer = setTimeout(async () => {
    const res = await fetch(`https://openlibrary.org/search.json?q=${encodeURIComponent(q)}&limit=5`);
    const data = await res.json();
    
    ddResults.innerHTML = data.docs.map(d => {
      const img = d.cover_i ? `https://covers.openlibrary.org/b/id/${d.cover_i}-S.jpg` : '';
      return `
        <div class="dd-item" onclick="selectBook('${d.title.replace(/'/g,"\\'")}', '${(d.author_name?.[0]||"").replace(/'/g,"\\'")}', '${img}')">
          <img src="${img}" style="width:30px; height:40px; background:#333; object-fit:cover;">
          <div>
            <div style="font-weight:bold; font-size:13px; color:#fff;">${d.title}</div>
            <div style="font-size:11px; color:#999;">${d.author_name?.[0]||'?'}</div>
          </div>
        </div>
      `;
    }).join('');
    ddResults.style.display = 'block';
  }, 400);
});

function selectBook(title, author, cover) {
  inpSearch.value = title;
  tempBook = { title, author, cover };
  ddResults.style.display = 'none';
}

// --- CRUD ---
function saveBook() {
  const title = inpSearch.value;
  if(!title) return alert("Serve un titolo!");
  
  const newBook = {
    id: crypto.randomUUID(),
    title: title,
    author: tempBook?.author || "Sconosciuto",
    cover: tempBook?.cover || "",
    status: document.getElementById('inpStatus').value,
    added: Date.now(),
    ...tempBook
  };
  
  books.push(newBook);
  localStorage.setItem(LS_KEY, JSON.stringify(books));
  
  renderList();
  showToast("Libro Aggiunto!");
  inpSearch.value = "";
  tempBook = null;
}

function deleteCurrent() {
  if(!currentId) return;
  if(!confirm("Sicuro?")) return;
  books = books.filter(b => b.id !== currentId);
  localStorage.setItem(LS_KEY, JSON.stringify(books));
  closeFocus();
  // Ricarica la vista corrente
  if(document.body.classList.contains('is-room')) renderRoom(); else renderList();
}

// --- RENDER LISTA ---
function renderList() {
  const container = document.getElementById('listContainer');
  container.innerHTML = books.map(b => `
    <div class="book-card" onclick="openFocus('${b.id}')">
      <img src="${b.cover}" class="bc-img" onerror="this.style.opacity=0.3">
      <div>
        <div style="font-weight:bold; margin-bottom:4px;">${b.title}</div>
        <div style="font-size:12px; color:var(--muted);">${b.author}</div>
        <div style="margin-top:8px; font-size:10px; padding:2px 6px; border:1px solid #444; display:inline-block; border-radius:4px;">
          ${mapStatus(b.status)}
        </div>
      </div>
    </div>
  `).join('');
}

// --- RENDER STANZA (IL CUORE DEL FIX) ---
function renderRoom() {
  // Pulisci le zone
  ['shelfHigh', 'shelfLow', 'tableZone', 'wishZone'].forEach(id => document.getElementById(id).innerHTML = '');

  // Ordina libri (per esempio alfabetico o per data)
  const sorted = [...books].sort((a,b) => b.added - a.added);

  sorted.forEach(b => {
    let el;
    
    // CASO 1: SCAFFALI (DORSI VERTICALI)
    if (b.status === 'read' || b.status === 'to_read') {
      el = document.createElement('div');
      el.className = 'spine-book';
      el.title = b.title + " - " + b.author;
      
      // Simula colore dorso casuale se non c'Ã¨ logica specifica, o basato su titolo
      const hue = (b.title.length * 40) % 360;
      el.style.background = `linear-gradient(to right, hsl(${hue}, 20%, 30%), hsl(${hue}, 20%, 40%) 30%, hsl(${hue}, 20%, 20%))`;
      
      // Altezza variabile random per realismo
      const h = 85 + (b.title.length % 15); 
      el.style.height = h + "%";
      
      el.onclick = () => openFocus(b.id);
      
      // Destinazione
      const dest = b.status === 'read' ? 'shelfHigh' : 'shelfLow';
      document.getElementById(dest).appendChild(el);
    }
    
    // CASO 2: TAVOLO (COPERTINE 3D)
    else if (b.status === 'reading') {
      el = document.createElement('div');
      el.className = 'table-book';
      el.onclick = () => openFocus(b.id);
      
      if(b.cover) {
        el.innerHTML = `<img src="${b.cover}">`;
      } else {
        el.innerHTML = `<div style="padding:10px; font-size:10px; color:#333; text-align:center; height:100%; display:flex; align-items:center; justify-content:center; background:#eee;">${b.title}</div>`;
      }
      
      document.getElementById('tableZone').appendChild(el);
    }
    
    // CASO 3: WISHLIST (MINIATURE)
    else if (b.status === 'wishlist') {
      el = document.createElement('div');
      el.className = 'wish-book';
      if(b.cover) el.style.backgroundImage = `url(${b.cover})`;
      el.style.backgroundSize = 'cover';
      el.onclick = () => openFocus(b.id);
      document.getElementById('wishZone').appendChild(el);
    }
  });
}

// --- FOCUS MODAL ---
function openFocus(id) {
  currentId = id;
  const b = books.find(x => x.id === id);
  if(!b) return;
  
  document.getElementById('fpTitle').innerText = b.title;
  document.getElementById('fpAuthor').innerText = b.author;
  document.getElementById('fpCover').src = b.cover || '';
  document.getElementById('fpStatusBadge').innerText = mapStatus(b.status);
  document.getElementById('focusOverlay').classList.add('on');
}

function closeFocus() {
  document.getElementById('focusOverlay').classList.remove('on');
  currentId = null;
}

function cycleStatus() {
  const b = books.find(x => x.id === currentId);
  const states = ['wishlist', 'to_read', 'reading', 'read'];
  const idx = states.indexOf(b.status);
  b.status = states[(idx + 1) % states.length];
  saveData();
  openFocus(b.id); // Refresh UI
  if(document.body.classList.contains('is-room')) renderRoom();
}

function searchAmazon() {
  const b = books.find(x => x.id === currentId);
  window.open(`https://www.amazon.it/s?k=${encodeURIComponent(b.title + " " + b.author)}`, '_blank');
}

// --- UTILS ---
function mapStatus(s) {
  const map = { 'read': 'Letto', 'to_read': 'Da Leggere', 'reading': 'In Lettura', 'wishlist': 'Wishlist' };
  return map[s] || s;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.innerText = msg; t.classList.add('on');
  setTimeout(()=>t.classList.remove('on'), 2000);
}

function saveData() {
  localStorage.setItem(LS_KEY, JSON.stringify(books));
}

function exportData() {
  const data = JSON.stringify(books, null, 2);
  const blob = new Blob([data], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'library.json';
  a.click();
}

// Init
switchView('list');

</script>
</body>
</html>
